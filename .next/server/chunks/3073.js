"use strict";exports.id=3073,exports.ids=[3073],exports.modules={14128:(a,b,c)=>{function d(a,b){let c=a.get(b);if("string"==typeof c)return c}function e(a){return a instanceof Error?{message:a.message,stack:a.stack,name:a.name}:a??null}c.d(b,{$:()=>e,U:()=>d})},26473:(a,b,c)=>{c.d(b,{In:()=>l,TN:()=>j,kZ:()=>h,lG:()=>n,rC:()=>i});var d=c(50904);let e="id,user_id,email,company_name,phone,website,created_at,updated_at,notify_quote_messages,notify_quote_winner";function f(a){if("string"!=typeof a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}function g(a){if("string"!=typeof a)return null;let b=a.trim();return b.length>0?b:null}async function h(a){if(!a)return null;try{let{data:b,error:c}=await d.w9.from("customers").select(e).eq("user_id",a).maybeSingle();if(c)return console.error("getCustomerByUserId: lookup failed",{userId:a,error:c}),null;return b??null}catch(b){return console.error("getCustomerByUserId: unexpected error",{userId:a,error:b}),null}}async function i(a){if(!a)return null;try{let{data:b,error:c}=await d.w9.from("customers").select(e).eq("id",a).maybeSingle();if(c)return console.error("getCustomerById: lookup failed",{customerId:a,error:c}),null;return b??null}catch(b){return console.error("getCustomerById: unexpected error",{customerId:a,error:b}),null}}async function j(a){let b=f(a.email);if(!b)return{ok:!1,error:"Your session is missing a valid email address.",details:{reason:"missing-email"}};let c=g(a.companyName)??b.split("@")[0]?.replace(/\W+/g," ").trim()??"Customer",i=g(a.phone),j=g(a.website);try{let f=await h(a.userId),g=await k(b);if(f){let a=await m(f.id,{company_name:c,phone:i,website:j});if(!a)return{ok:!1,error:"We couldn’t update your existing profile record.",details:{reason:"update-existing-user",customerId:f.id}};return{ok:!0,customer:a,operation:"updated_user"}}if(g){let b=await m(g.id,{user_id:a.userId,company_name:c,phone:i,website:j});if(!b)return{ok:!1,error:"We couldn’t link your profile to this account.",details:{reason:"update-existing-email",customerId:g.id}};return{ok:!0,customer:b,operation:"linked_email"}}let n={user_id:a.userId,email:b,company_name:c,phone:i,website:j,updated_at:new Date().toISOString()},{data:o,error:p}=await d.w9.from("customers").insert(n).select(e).single();if(p||!o){var l;if(l=p,l?.code&&"23505"===l.code){let d=await k(b);if(d){let b=await m(d.id,{user_id:a.userId,company_name:c,phone:i,website:j});if(b)return{ok:!0,customer:b,operation:"linked_email"}}}return console.error("upsertCustomerProfileForUser: insert failed",{userId:a.userId,email:b,payload:n,error:p}),{ok:!1,error:"We couldn’t create your customer profile right now.",details:p}}return{ok:!0,customer:o,operation:"inserted"}}catch(c){return console.error("upsertCustomerProfileForUser: unexpected error",{userId:a.userId,email:b,error:c}),{ok:!1,error:"Unexpected error while saving your customer profile.",details:c}}}async function k(a){let b=f(a);if(!b)return null;try{let{data:a,error:c}=await d.w9.from("customers").select(e).ilike("email",b).maybeSingle();if(c)return console.error("getCustomerByEmail: lookup failed",{email:b,error:c}),null;return a??null}catch(a){return console.error("getCustomerByEmail: unexpected error",{email:b,error:a}),null}}async function l(a,b){let c=f(b);if(a&&c)try{let{error:b}=await d.w9.from("quotes").update({customer_id:a,updated_at:new Date().toISOString()}).is("customer_id",null).ilike("email",c);b&&console.error("attachQuotesToCustomer: update failed",{customerId:a,email:c,error:b})}catch(b){console.error("attachQuotesToCustomer: unexpected error",{customerId:a,email:c,error:b})}}async function m(a,b){let{data:c,error:f}=await d.w9.from("customers").update({...b,updated_at:new Date().toISOString()}).eq("id",a).select(e).maybeSingle();return f?(console.error("updateCustomer: update failed",{customerId:a,changes:b,error:f}),null):c??null}async function n(a){let b=f(a.email);if(!b)throw Error("A valid email address is required.");let c=g(a.companyName)||b.split("@")[0]?.replace(/\W+/g," ").trim()||"Customer",h={email:b,company_name:c,phone:g(a.phone),updated_at:new Date().toISOString()};try{let{data:a,error:c}=await d.w9.from("customers").upsert(h,{onConflict:"email"}).select(e).single();if(c)return console.error("upsertCustomerByEmail: upsert failed",{email:b,payload:h,error:c}),null;return a??null}catch(a){return console.error("upsertCustomerByEmail: unexpected error",{email:b,error:a}),null}}},26611:(a,b,c)=>{c.d(b,{x:()=>g});var d=c(50904),e=c(15656);let f="We couldn’t update the project details. Please retry.";async function g(a){var b;let c="string"==typeof(b=a?.quoteId)?b.trim():"",g=function(a){if("string"!=typeof a)return null;let b=a.trim();return b?b.slice(0,100):null}(a?.poNumber),i=function(a){if("string"!=typeof a)return null;let b=a.trim();return b&&h.test(b)?b:null}(a?.targetShipDate),j=function(a){if("string"!=typeof a)return null;let b=a.trim();return b?b.slice(0,2e3):null}(a?.notes);if(!c)return{ok:!1,data:null,error:f};console.log("[quote projects] upsert start",{quoteId:c,hasPoNumber:!!g,hasTargetDate:!!i});try{let a={quote_id:c,po_number:g,target_ship_date:i,notes:j,updated_at:new Date().toISOString()},{data:b,error:h}=await d.w9.from("quote_projects").upsert(a,{onConflict:"quote_id"}).select("id,quote_id,po_number,target_ship_date,notes,created_at,updated_at").single();if(h||!b){let a=(0,e.H)(h);return(0,e.uW)(h)?console.warn("[quote projects] upsert missing schema",{quoteId:c,error:a}):console.error("[quote projects] upsert failed",{quoteId:c,error:a}),{ok:!1,data:null,error:f}}return console.log("[quote projects] upsert success",{quoteId:c}),{ok:!0,data:b,error:null}}catch(b){let a=(0,e.H)(b);return(0,e.uW)(b)?console.warn("[quote projects] upsert crashed (missing schema)",{quoteId:c,error:a}):console.error("[quote projects] upsert crashed",{quoteId:c,error:a??b}),{ok:!1,data:null,error:f}}}let h=/^\d{4}-\d{2}-\d{2}$/},52453:(a,b,c)=>{c.d(b,{LC:()=>h,cz:()=>g,ie:()=>j});var d=c(50904),e=c(26473),f=c(31722);async function g(a){let b=await k(a);return b?{id:b.id,file_name:b.file_name??null,company:b.company??null,customer_name:b.customer_name??null,email:b.email??null,status:b.status??null,price:b.price??null,currency:b.currency??null}:null}async function h(a){let b=await k(a);if(!b)return null;let{status:c,price:d,currency:f,...g}=b,h=g.customer_id&&g.customer_id.length>0?await (0,e.rC)(g.customer_id):null;return{quote:g,customer:h}}async function i(a){if(!a)return null;try{let{data:b,error:c}=await d.w9.from("supplier_bids").select("*").eq("id",a).maybeSingle();if(c)return console.error("[quote notifications] bid lookup failed",{bidId:a,error:c}),null;return b??null}catch(b){return console.error("[quote notifications] bid lookup crashed",{bidId:a,error:b}),null}}async function j(a){let b=await i(a);if(!b)return console.warn("[quote notifications] winner context missing bid",{bidId:a}),null;if(!b.supplier_id)return console.warn("[quote notifications] winner context missing supplier id",{bidId:a,quoteId:b.quote_id}),null;let c=await (0,f.n1)(b.supplier_id);return c?{winningBid:b,supplier:c}:(console.warn("[quote notifications] winner context missing supplier record",{bidId:a,supplierId:b.supplier_id}),null)}async function k(a){if(!a)return null;try{let{data:b,error:c}=await d.w9.from("quotes_with_uploads").select("id,file_name,company,customer_name,email,customer_id,status,price,currency").eq("id",a).maybeSingle();if(c)return console.error("[quote notifications] quote lookup failed",{quoteId:a,error:c}),null;return b??null}catch(b){return console.error("[quote notifications] quote lookup crashed",{quoteId:a,error:b}),null}}},94454:(a,b,c)=>{c.d(b,{c:()=>l,V:()=>m});let d=process.env.RESEND_API_KEY,e=process.env.NOTIFICATIONS_FROM_EMAIL??"Zartman <notifications@zartman.io>";async function f(a){var b;if(!a?.to)return void console.warn("[notifications] missing recipient email",{subject:a?.subject??null});if(!d)return void console.warn("[notifications] RESEND_API_KEY not configured; email skipped",{to:a.to,subject:a.subject});let c={from:e,to:a.to,subject:a.subject,html:a.previewText?`${b=a.previewText,`<div style="display:none;font-size:1px;color:#fefefe;line-height:1px;max-height:0px;max-width:0px;opacity:0;overflow:hidden;">${b}</div>`}${a.html}`:a.html};try{let b=await fetch("https://api.resend.com/emails",{method:"POST",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},body:JSON.stringify(c)});if(!b.ok){let c=await g(b);console.error("[notifications] email send failed",{to:a.to,subject:a.subject,status:b.status,error:c})}}catch(b){console.error("[notifications] email send crashed",{to:a.to,subject:a.subject,error:b instanceof Error?{message:b.message,stack:b.stack}:String(b)})}}async function g(a){try{return await a.json()}catch{return{statusText:a.statusText}}}function h(a,b){if(!a)return!0;switch(b){case"quote_message_customer":return a.notify_quote_messages??!0;case"winner_customer":return a.notify_quote_winner??!0;default:return!0}}function i(a,b){if(!a)return!0;switch(b){case"quote_message_supplier":return a.notify_quote_messages??!0;case"winner_supplier":return a.notify_quote_winner??!0;default:return!0}}var j=c(52453);let k=process.env.NOTIFICATIONS_ADMIN_EMAIL??"admin@zartman.io";async function l(a){var b,c;let d=await (0,j.LC)(a.quote_id);if(!d)return void console.warn("[quote notifications] message skipped",{quoteId:a.quote_id,authorType:a.author_type,reason:"missing-quote-context"});let{quote:e,customer:g}=d,l=(b=a.author_type,c=e,"customer"===b?{email:k,label:"Zartman admin",type:"admin"}:"admin"===b||"supplier"===b?c.email?{email:c.email,label:c.customer_name??c.company??"Customer",type:"customer"}:null:null);if(!l)return void console.log("[quote notifications] message skipped",{quoteId:e.id,authorType:a.author_type,reason:"recipient-unavailable"});if("customer"===l.type&&!h(g,"quote_message_customer"))return void console.log("[quote notifications] message skipped due to preferences",{quoteId:e.id,recipientType:"customer"});if("supplier"===l.type&&!i(l.supplier??null,"quote_message_supplier"))return void console.log("[quote notifications] message skipped due to preferences",{quoteId:e.id,recipientType:"supplier",supplierId:l.supplier?.id??null});try{await f({to:l.email,subject:`New message on RFQ ${n(e)}`,previewText:`${l.label} received a new message on quote ${e.id}`,html:function(a,b,c){let d=o("customer"===a.author_type?`/admin/quotes/${b.id}`:`/customer/quotes/${b.id}`);return`
    <p>${c},</p>
    <p><strong>${a.author_name??"A teammate"}</strong> posted a new message on <strong>${n(b)}</strong>.</p>
    <blockquote style="border-left:4px solid #94a3b8;padding:0.5rem 1rem;color:#0f172a;">${a.body}</blockquote>
    <p><a href="${d}">Open the workspace</a> to reply.</p>
  `}(a,e,l.label)}),console.log("[quote notifications] message dispatched",{quoteId:e.id,authorType:a.author_type,recipientType:l.type})}catch(b){console.error("[quote notifications] message email failed",{quoteId:e.id,authorType:a.author_type,recipientType:l.type,error:b})}}async function m(a){let b=a.supplier.primary_email??null,c=a.customer?.email??a.quote.email??null,d=n(a.quote),e=o(`/supplier/quotes/${a.quote.id}`),g=o(`/customer/quotes/${a.quote.id}`),j=function(a,b,c){if("number"!=typeof a||Number.isNaN(a))return"—";let d=(b??"USD").toUpperCase(),e=(void 0)??0,f=(void 0)??e;try{return new Intl.NumberFormat("en-US",{style:"currency",currency:d,minimumFractionDigits:f,maximumFractionDigits:e}).format(a)}catch{let b=Math.max(f,e);return`${d} ${a.toFixed(b)}`}}(function(a){if("number"==typeof a)return a;if("string"==typeof a){let b=Number(a);return Number.isNaN(b)?null:b}return null}(a.winningBid.unit_price),a.winningBid.currency??a.quote.currency??"USD"),k="number"==typeof a.winningBid.lead_time_days?`${a.winningBid.lead_time_days} day${1===a.winningBid.lead_time_days?"":"s"}`:"Lead time not provided",l=[],m=!1,p=!1;if(i(a.supplier,"winner_supplier")?b&&(l.push(f({to:b,subject:`Your bid won – RFQ ${d}`,previewText:`We selected your proposal for ${d}.`,html:`
            <p>Congrats! Your bid for <strong>${d}</strong> was selected as the winner.</p>
            <p><strong>Price:</strong> ${j}<br/>
            <strong>Lead time:</strong> ${k}</p>
            <p><a href="${e}">Open the supplier workspace</a> to review next steps.</p>
          `})),m=!0):console.log("[quote notifications] winner email skipped (supplier prefs)",{quoteId:a.quote.id,bidId:a.winningBid.id,supplierId:a.supplier.id}),h(a.customer,"winner_customer")?c&&(l.push(f({to:c,subject:"Winning supplier selected for your RFQ",previewText:`We marked a winning supplier for ${d}.`,html:`
            <p>You selected <strong>${a.supplier.company_name??"a supplier"}</strong> for <strong>${d}</strong>.</p>
            <p><strong>Winning bid:</strong> ${j} (${k})</p>
            <p><a href="${g}">View the quote workspace</a> to keep the project moving.</p>
          `})),p=!0):console.log("[quote notifications] winner email skipped (customer prefs)",{quoteId:a.quote.id,bidId:a.winningBid.id,customerId:a.customer?.id??null}),0===l.length)return void console.log("[quote notifications] winning bid emails skipped",{quoteId:a.quote.id,bidId:a.winningBid.id,supplierId:a.supplier.id,reason:"no-allowed-recipients"});try{await Promise.all(l),console.log("[quote notifications] winning bid emails dispatched",{quoteId:a.quote.id,bidId:a.winningBid.id,supplierId:a.supplier.id,supplierNotified:m,customerNotified:p})}catch(b){console.error("[quote notifications] winning bid email failed",{quoteId:a.quote.id,bidId:a.winningBid.id,supplierId:a.supplier.id,error:b})}}function n(a){return a.file_name??a.company??`Quote ${a.id.slice(0,6)}`}function o(a){return`https://zartman.io${a}`}}};