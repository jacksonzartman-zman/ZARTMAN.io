"use strict";exports.id=5641,exports.ids=[5641],exports.modules={25049:(a,b,c)=>{c.d(b,{L:()=>d});let d=["id","upload_id","customer_name","email","company","status","price","currency","created_at","updated_at","target_date","file_name"]},31023:(a,b,c)=>{c.d(b,{Eh:()=>l,GG:()=>m,H:()=>p,On:()=>n,R0:()=>h,Ro:()=>f,gA:()=>i,gF:()=>k,gQ:()=>j,pU:()=>g,uW:()=>r});let d={quotes:"[admin quotes]",uploads:"[admin uploads]",dashboard:"[admin dashboard]"};function e(a,b,c,e){let f=d[a],g=function(a){if(!a)return null;let b=Object.entries(a).filter(([,a])=>void 0!==a);return 0===b.length?null:Object.fromEntries(b)}(e),h=[`${f} ${c}`,...g&&Object.keys(g).length>0?[g]:[]];return"error"===b?void console.error(...h):"warn"===b?void console.warn(...h):void console.log(...h)}function f(a,b){e("quotes","info",a,b)}function g(a,b){e("quotes","warn",a,b)}function h(a,b){e("quotes","error",a,b)}function i(a,b){e("uploads","info",a,b)}function j(a,b){e("uploads","warn",a,b)}function k(a,b){e("uploads","error",a,b)}function l(a,b){e("dashboard","info",a,b)}function m(a,b){e("dashboard","warn",a,b)}function n(a,b){e("dashboard","error",a,b)}function o(a){return a&&"object"==typeof a&&"supabaseError"in a&&a.supabaseError?a.supabaseError:a}function p(a){let b=o(a);return b&&"object"==typeof b?{code:"string"==typeof b.code?b.code:null,message:"string"==typeof b.message?b.message:null,details:"string"==typeof b.details?b.details:null,hint:"string"==typeof b.hint?b.hint:null}:b??null}let q=new Set(["PGRST205","42703"]);function r(a){let b=o(a);if(!b||"object"!=typeof b)return!1;let c="code"in b&&"string"==typeof b.code?b.code:null;return!!c&&q.has(c)}},33358:(a,b,c)=>{c.d(b,{Ao:()=>h,Bg:()=>i,GM:()=>g,Hk:()=>f,RH:()=>j,_A:()=>e,l5:()=>d});let d=["submitted","in_review","quoted","approved","won","lost","cancelled"],e="submitted",f=["submitted","in_review","quoted"],g={submitted:"RFQ submitted",in_review:"In review",quoted:"Quote prepared",approved:"Approved",won:"Won",lost:"Lost",cancelled:"Cancelled"};function h(a){let b=(a??"").toLowerCase().trim();return"in_review"===b?"in_review":"quoted"===b?"quoted":"approved"===b?"approved":"won"===b?"won":"lost"===b?"lost":"cancelled"===b||"canceled"===b?"cancelled":"submitted"}function i(a){return f.includes(h(a))}function j(a){return g[h(a)]??"Status update"}},40257:(a,b,c)=>{c.d(b,{vT:()=>x,cE:()=>r,X1:()=>y,Vv:()=>s});var d=c(81518),e=c(12831);let f=process.env.RESEND_API_KEY,g=process.env.NOTIFICATIONS_FROM_EMAIL??"Zartman <notifications@zartman.io>";async function h(a){var b;if(!a?.to)return void console.warn("[notifications] missing recipient email",{subject:a?.subject??null});if(!f)return void console.warn("[notifications] RESEND_API_KEY not configured; email skipped",{to:a.to,subject:a.subject});let c={from:g,to:a.to,subject:a.subject,html:a.previewText?`${b=a.previewText,`<div style="display:none;font-size:1px;color:#fefefe;line-height:1px;max-height:0px;max-width:0px;opacity:0;overflow:hidden;">${b}</div>`}${a.html}`:a.html};try{let b=await fetch("https://api.resend.com/emails",{method:"POST",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json"},body:JSON.stringify(c)});if(!b.ok){let c=await i(b);console.error("[notifications] email send failed",{to:a.to,subject:a.subject,status:b.status,error:c})}}catch(b){console.error("[notifications] email send crashed",{to:a.to,subject:a.subject,error:b instanceof Error?{message:b.message,stack:b.stack}:String(b)})}}async function i(a){try{return await a.json()}catch{return{statusText:a.statusText}}}async function j(a,b){let c=l(a);console.log("[notifications] dispatch start",c);try{return await b(),console.log("[notifications] dispatch success",c),!0}catch(a){var d;return console.error("[notifications] dispatch failed",{...c,error:(d=a)instanceof Error?{name:d.name,message:d.message,stack:d.stack}:d&&"object"==typeof d?{...d}:d??null}),!1}}async function k(a){let{subject:b,previewText:c,html:d,skipIfMissingRecipient:e=!0,...f}=a,g=f.recipientEmail??null,i=l({...f,recipientEmail:g});return!g&&e?(console.warn("[notifications] dispatch skipped",{...i,reason:"missing-recipient"}),!1):j({...f,recipientEmail:g,channel:f.channel??"email"},()=>h({to:g??"",subject:b,previewText:c,html:d}))}function l(a){return{eventType:a.eventType,quoteId:a.quoteId??null,recipientEmail:a.recipientEmail??null,audience:a.audience??null,channel:a.channel??null,payload:a.payload??null}}function m(a,b){if(!a)return!0;switch(b){case"quote_message_customer":return a.notify_quote_messages??!0;case"winner_customer":return a.notify_quote_winner??!0;default:return!0}}function n(a,b){if(!a)return!0;switch(b){case"quote_message_supplier":return a.notify_quote_messages??!0;case"winner_supplier":return a.notify_quote_winner??!0;default:return!0}}var o=c(86900),p=c(33358);let q=process.env.NOTIFICATIONS_ADMIN_EMAIL??"admin@zartman.io";async function r(a){var b,c;let d=await (0,o.LC)(a.quote_id);if(!d)return void console.warn("[quote notifications] message skipped",{quoteId:a.quote_id,authorType:a.author_type,reason:"missing-quote-context"});let{quote:e,customer:f}=d,g=(b=a.author_type,c=e,"customer"===b?{email:q,label:"Zartman admin",type:"admin"}:"admin"===b||"supplier"===b?c.email?{email:c.email,label:c.customer_name??c.company??"Customer",type:"customer"}:null:null);return g?"customer"!==g.type||m(f,"quote_message_customer")?"supplier"!==g.type||n(g.supplier??null,"quote_message_supplier")?void await k({eventType:"quote_message_posted",quoteId:e.id,recipientEmail:g.email,audience:"customer"===g.type?"customer":"supplier"===g.type?"supplier":"admin",payload:{authorType:a.author_type,recipientType:g.type,messageId:a.id},subject:`New message on RFQ ${u(e)}`,previewText:`${g.label} received a new message on quote ${e.id}`,html:function(a,b,c){let d=v("customer"===a.author_type?`/admin/quotes/${b.id}`:`/customer/quotes/${b.id}`);return`
    <p>${c},</p>
    <p><strong>${a.author_name??"A teammate"}</strong> posted a new message on <strong>${u(b)}</strong>.</p>
    <blockquote style="border-left:4px solid #94a3b8;padding:0.5rem 1rem;color:#0f172a;">${a.body}</blockquote>
    <p><a href="${d}">Open the workspace</a> to reply.</p>
  `}(a,e,g.label)}):void console.log("[quote notifications] message skipped due to preferences",{quoteId:e.id,recipientType:"supplier",supplierId:g.supplier?.id??null}):void console.log("[quote notifications] message skipped due to preferences",{quoteId:e.id,recipientType:"customer"}):void console.log("[quote notifications] message skipped",{quoteId:e.id,authorType:a.author_type,reason:"recipient-unavailable"})}async function s(a){let b=a.supplier.primary_email??null,c=a.customer?.email??a.quote.email??null,e=u(a.quote),f=v(`/supplier/quotes/${a.quote.id}`),g=v(`/customer/quotes/${a.quote.id}`),h=function(a){if("number"==typeof a)return a;if("string"==typeof a){let b=Number(a);return Number.isNaN(b)?null:b}return null}(a.winningBid.unit_price),i=(0,d.v)(h,a.winningBid.currency??a.quote.currency??"USD"),j="number"==typeof a.winningBid.lead_time_days?`${a.winningBid.lead_time_days} day${1===a.winningBid.lead_time_days?"":"s"}`:"Lead time not provided",l=[],o=!1,p=!1;n(a.supplier,"winner_supplier")?b&&(l.push(k({eventType:"bid_won",quoteId:a.quote.id,recipientEmail:b,audience:"supplier",payload:{bidId:a.winningBid.id,supplierId:a.supplier.id},subject:`Your bid won – RFQ ${e}`,previewText:`We selected your proposal for ${e}.`,html:`
            <p>Congrats! Your bid for <strong>${e}</strong> was selected as the winner.</p>
            <p><strong>Price:</strong> ${i}<br/>
            <strong>Lead time:</strong> ${j}</p>
            <p><a href="${f}">Open the supplier workspace</a> to review next steps.</p>
          `})),o=!0):console.log("[quote notifications] winner email skipped (supplier prefs)",{quoteId:a.quote.id,bidId:a.winningBid.id,supplierId:a.supplier.id}),m(a.customer,"winner_customer")?c&&(l.push(k({eventType:"quote_won",quoteId:a.quote.id,recipientEmail:c,audience:"customer",payload:{bidId:a.winningBid.id,supplierId:a.supplier.id},subject:"Winning supplier selected for your RFQ",previewText:`We marked a winning supplier for ${e}.`,html:`
            <p>You selected <strong>${a.supplier.company_name??"a supplier"}</strong> for <strong>${e}</strong>.</p>
            <p><strong>Winning bid:</strong> ${i} (${j})</p>
            <p><a href="${g}">View the quote workspace</a> to keep the project moving.</p>
          `})),p=!0):console.log("[quote notifications] winner email skipped (customer prefs)",{quoteId:a.quote.id,bidId:a.winningBid.id,customerId:a.customer?.id??null}),0===l.length?console.log("[quote notifications] winning bid emails skipped",{quoteId:a.quote.id,bidId:a.winningBid.id,supplierId:a.supplier.id,reason:"no-allowed-recipients"}):(await Promise.allSettled(l),console.log("[quote notifications] winning bid notifications dispatched",{quoteId:a.quote.id,bidId:a.winningBid.id,supplierId:a.supplier.id,supplierNotified:o,customerNotified:p})),await t({quote:a.quote,winningBidId:a.winningBid.id,winningSupplierName:a.supplier.company_name??a.supplier.primary_email??"another supplier"})}async function t(a){try{let{data:b,error:c}=await e.w9.from("supplier_bids").select("id,supplier_id,status,unit_price,currency,lead_time_days,updated_at").eq("quote_id",a.quote.id).neq("id",a.winningBidId);if(c)return void console.error("[quote notifications] losing supplier lookup failed",{quoteId:a.quote.id,error:c});let d=(b??[]).filter(a=>"lost"===(a.status??"").toLowerCase());if(0===d.length)return;let f=Array.from(new Set(d.map(a=>a.supplier_id).filter(a=>!!a)));if(0===f.length)return;let{data:g,error:h}=await e.w9.from("suppliers").select("id,company_name,primary_email").in("id",f);if(h)return void console.error("[quote notifications] losing supplier context failed",{quoteId:a.quote.id,error:h});let i=new Map((g??[]).map(a=>[a.id,a])),j=u(a.quote);await Promise.all(d.map(b=>{let c=b.supplier_id?i.get(b.supplier_id):null,d=c?.primary_email??null;return d?k({eventType:"bid_lost",quoteId:a.quote.id,recipientEmail:d,audience:"supplier",payload:{bidId:b.id,supplierId:b.supplier_id},subject:`RFQ ${j} closed`,previewText:`We selected another supplier for ${j}.`,html:function(a){let b=v(`/supplier/quotes/${a.quoteId}`);return`
    <p>Thanks for submitting a proposal for <strong>${a.quoteTitle}</strong>.</p>
    <p>We selected ${a.winningSupplierName??"another supplier"} for this project. We'll keep you posted when future RFQs are a fit.</p>
    <p><a href="${b}">Open the supplier workspace</a> to review the RFQ details.</p>
  `}({quoteTitle:j,winningSupplierName:a.winningSupplierName,quoteId:a.quote.id})}):(console.warn("[quote notifications] losing supplier missing email",{quoteId:a.quote.id,bidId:b.id,supplierId:b.supplier_id}),Promise.resolve(!1))}))}catch(b){console.error("[quote notifications] losing supplier notify failed",{quoteId:a.quote.id,error:b})}}function u(a){return a.file_name??a.company??`Quote ${a.id.slice(0,6)}`}function v(a){return`https://zartman.io${a}`}let w={quoted:{eventType:"quote_quoted",subject:a=>`Quote ready for ${a}`,previewText:"Review pricing and DFM notes.",body:({quoteTitle:a,quoteId:b,statusLabel:c})=>{let d=v(`/customer/quotes/${b}`);return`
        <p>We updated <strong>${a}</strong> to <strong>${c}</strong>.</p>
        <p><a href="${d}">Open your workspace</a> to review the quote package.</p>
      `}},approved:{eventType:"quote_approved",subject:a=>`${a} approved for kickoff`,previewText:"We signed off on your RFQ.",body:({quoteTitle:a,quoteId:b,statusLabel:c})=>{let d=v(`/customer/quotes/${b}`);return`
        <p>${a} is now <strong>${c}</strong>. We're lining up the next steps.</p>
        <p><a href="${d}">View the RFQ</a> to share kickoff details.</p>
      `}},won:{eventType:"quote_won",subject:a=>`${a} marked as won`,previewText:"We selected a supplier for this RFQ.",body:({quoteTitle:a,quoteId:b,statusLabel:c})=>{let d=v(`/customer/quotes/${b}`);return`
        <p>${a} is <strong>${c}</strong>. We captured the winning proposal in your workspace.</p>
        <p><a href="${d}">Open the workspace</a> to coordinate kickoff.</p>
      `}}};async function x(a){let b=w[a.status];if(!b)return;let c=a.context??await (0,o.LC)(a.quoteId);if(!c?.quote?.email)return void console.warn("[quote notifications] status email skipped",{quoteId:a.quoteId,status:a.status,reason:"missing-recipient"});let d=u(c.quote),e=(0,p.RH)(a.status);await k({eventType:b.eventType,quoteId:a.quoteId,recipientEmail:c.quote.email,audience:"customer",payload:{status:a.status},subject:b.subject(d),previewText:b.previewText,html:b.body({quoteTitle:d,quoteId:a.quoteId,statusLabel:e})})}async function y(a){try{let b=await A(a.quoteId);if(!b)return void console.warn("[quote notifications] project kickoff skipped",{quoteId:a.quoteId,reason:"missing-quote-context"});let c=u(b),d=function(a){let b=[],c=B(a.po_number);c&&b.push(`<li><strong>PO #</strong>: ${c}</li>`);let d=B(a.target_ship_date);d&&b.push(`<li><strong>Target ship date</strong>: ${d}</li>`);let e=function(a){let b=B(a);return b?b.replace(/\r?\n/g,"<br/>"):null}(a.notes);return(e&&b.push(`<li><strong>Notes</strong>: ${e}</li>`),0===b.length)?"<p>No kickoff details were provided.</p>":`<ul>${b.join("")}</ul>`}(a.project),e=a.created?"project_kickoff_created":"project_kickoff_updated",f=a.project.po_number??a.project.target_ship_date??(a.created?"Kickoff created":"Kickoff updated"),g={projectId:a.project.id,created:a.created},h=[];b.email&&h.push(k({eventType:e,quoteId:a.quoteId,recipientEmail:b.email,audience:"customer",payload:g,subject:`${a.created?"Project kickoff captured":"Project kickoff updated"} for ${c}`,previewText:f,html:z({audience:"customer",quoteTitle:c,summaryHtml:d,link:v(`/customer/quotes/${a.quoteId}`),created:a.created})})),b.assigned_supplier_email&&h.push(k({eventType:e,quoteId:a.quoteId,recipientEmail:b.assigned_supplier_email,audience:"supplier",payload:g,subject:`Kickoff details for ${c}`,previewText:f,html:z({audience:"supplier",quoteTitle:c,summaryHtml:d,link:v(`/supplier/quotes/${a.quoteId}`),created:a.created})})),h.push(k({eventType:e,quoteId:a.quoteId,recipientEmail:q,audience:"admin",payload:g,subject:`[Admin] ${a.created?"Project kickoff created":"Project kickoff updated"} (${c})`,previewText:f,html:z({audience:"admin",quoteTitle:c,summaryHtml:d,link:v(`/admin/quotes/${a.quoteId}`),created:a.created})})),await Promise.allSettled(h)}catch(b){console.error("[quote notifications] project kickoff notify failed",{quoteId:a.quoteId,error:b})}}function z(a){let b="supplier"===a.audience?`The customer shared kickoff details for <strong>${a.quoteTitle}</strong>.`:"customer"===a.audience?`We ${a.created?"captured":"updated"} kickoff info for <strong>${a.quoteTitle}</strong>.`:`Kickoff info for <strong>${a.quoteTitle}</strong> was ${a.created?"created":"updated"}.`;return`
    <p>${b}</p>
    ${a.summaryHtml}
    <p><a href="${a.link}">Open the workspace</a> to review.</p>
  `}async function A(a){if(!a)return null;try{let{data:b,error:c}=await e.w9.from("quotes_with_uploads").select("id,file_name,company,customer_name,email,assigned_supplier_email,assigned_supplier_name").eq("id",a).maybeSingle();if(c)return console.error("[quote notifications] project quote lookup failed",{quoteId:a,error:c}),null;return b??null}catch(b){return console.error("[quote notifications] project quote lookup crashed",{quoteId:a,error:b}),null}}function B(a){if("string"!=typeof a)return null;let b=a.trim();return b?b.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):null}},81518:(a,b,c)=>{c.d(b,{v:()=>d});function d(a,b,c){if("number"!=typeof a||Number.isNaN(a))return"—";let d=(b??"USD").toUpperCase(),e=c?.maximumFractionDigits??0,f=c?.minimumFractionDigits??e;try{return new Intl.NumberFormat("en-US",{style:"currency",currency:d,minimumFractionDigits:f,maximumFractionDigits:e}).format(a)}catch{let b=Math.max(f,e);return`${d} ${a.toFixed(b)}`}}},84472:(a,b,c)=>{c.d(b,{S7:()=>h,kZ:()=>f,rC:()=>g});var d=c(12831);let e="id,user_id,email,company_name,created_at,notify_quote_messages,notify_quote_winner";async function f(a){if(!a)return null;try{let{data:b,error:c}=await d.w9.from("customers").select(e).eq("user_id",a).maybeSingle();if(c)return console.error("getCustomerByUserId: lookup failed",{userId:a,error:c}),null;return b??null}catch(b){return console.error("getCustomerByUserId: unexpected error",{userId:a,error:b}),null}}async function g(a){if(!a)return null;try{let{data:b,error:c}=await d.w9.from("customers").select(e).eq("id",a).maybeSingle();if(c)return console.error("getCustomerById: lookup failed",{customerId:a,error:c}),null;return b??null}catch(b){return console.error("getCustomerById: unexpected error",{customerId:a,error:b}),null}}async function h(a){let b=function(a){if("string"!=typeof a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}(a);if(!b)return null;try{let{data:a,error:c}=await d.w9.from("customers").select(e).ilike("email",b).maybeSingle();if(c)return console.error("getCustomerByEmail: lookup failed",{email:b,error:c}),null;return a??null}catch(a){return console.error("getCustomerByEmail: unexpected error",{email:b,error:a}),null}}},86900:(a,b,c)=>{c.d(b,{LC:()=>h,cz:()=>g,ie:()=>j});var d=c(12831),e=c(84472),f=c(49669);async function g(a){let b=await k(a);return b?{id:b.id,file_name:b.file_name??null,company:b.company??null,customer_name:b.customer_name??null,email:b.email??null,status:b.status??null,price:b.price??null,currency:b.currency??null}:null}async function h(a){let b=await k(a);if(!b)return null;let{status:c,price:d,currency:e,...f}=b,g=await l(f);return{quote:f,customer:g}}async function i(a){if(!a)return null;try{let{data:b,error:c}=await d.w9.from("supplier_bids").select("*").eq("id",a).maybeSingle();if(c)return console.error("[quote notifications] bid lookup failed",{bidId:a,error:c}),null;return b??null}catch(b){return console.error("[quote notifications] bid lookup crashed",{bidId:a,error:b}),null}}async function j(a){let b=await i(a);if(!b)return console.warn("[quote notifications] winner context missing bid",{bidId:a}),null;if(!b.supplier_id)return console.warn("[quote notifications] winner context missing supplier id",{bidId:a,quoteId:b.quote_id}),null;let c=await (0,f.n1)(b.supplier_id);return c?{winningBid:b,supplier:c}:(console.warn("[quote notifications] winner context missing supplier record",{bidId:a,supplierId:b.supplier_id}),null)}async function k(a){if(!a)return null;try{let{data:b,error:c}=await d.w9.from("quotes_with_uploads").select("id,file_name,company,customer_name,email,status,price,currency").eq("id",a).maybeSingle();if(c)return console.error("[quote notifications] quote lookup failed",{quoteId:a,error:c}),null;return b??null}catch(b){return console.error("[quote notifications] quote lookup crashed",{quoteId:a,error:b}),null}}async function l(a){if(!a.email)return null;try{return await (0,e.S7)(a.email)??null}catch(b){return console.warn("[quote notifications] customer enrichment skipped",{quoteId:a.id,reason:"lookup-failed",error:b}),null}}},95641:(a,b,c)=>{c.d(b,{CQ:()=>w,KO:()=>s,TT:()=>o,ZU:()=>p,lO:()=>t,pK:()=>x,s3:()=>n});var d=c(12831),e=c(86900),f=c(33358),g=c(40257),h=c(25049),i=c(31023);let j=[...h.L],k=[...j],l="Unable to load quotes right now. Please refresh to try again.",m="Unable to load this quote right now.",n="Unable to update this quote right now. Please try again.";async function o(a){try{let{data:b,error:c}=await d.w9.from("quotes_with_uploads").select(j.join(",")).order("created_at",{ascending:!1}).limit(100).returns();if(c)return(0,i.uW)(c)?(0,i.pU)("list missing schema",{status:a.status??null,search:a.search??null,supabaseError:(0,i.H)(c)}):(0,i.R0)("list query failed",{status:a.status??null,search:a.search??null,supabaseError:(0,i.H)(c)}),{ok:!1,data:[],error:l};let e=b??[];return(0,i.Ro)("list loaded",{count:e.length,status:a.status??null,search:a.search??null}),{ok:!0,data:e,error:null}}catch(b){return(0,i.R0)("list crashed",{status:a.status??null,search:a.search??null,supabaseError:(0,i.H)(b)}),{ok:!1,data:[],error:l}}}async function p(a){if("string"!=typeof a||0===a.trim().length)return(0,i.pU)("detail requested without id",{quoteId:a}),{ok:!0,data:null,error:null};try{let{data:b,error:c}=await d.w9.from("quotes_with_uploads").select(k.join(",")).eq("id",a).maybeSingle();if(c)return(0,i.uW)(c)?(0,i.pU)("detail missing schema",{quoteId:a,supabaseError:(0,i.H)(c)}):(0,i.R0)("detail query failed",{quoteId:a,supabaseError:(0,i.H)(c)}),{ok:!1,data:null,error:m};if(!b)return(0,i.Ro)("detail not found",{quoteId:a}),{ok:!0,data:null,error:null};let e=await q(a),f={...b,...e};return(0,i.Ro)("detail loaded",{quoteId:a}),{ok:!0,data:f,error:null}}catch(b){return(0,i.R0)("detail crashed",{quoteId:a,supabaseError:(0,i.H)(b)}),{ok:!1,data:null,error:m}}}async function q(a){let b={dfm_notes:null,internal_notes:null};try{let{data:c,error:e}=await d.w9.from("quotes").select("dfm_notes,internal_notes").eq("id",a).maybeSingle();if(e)return(0,i.uW)(e)?console.warn("[admin quotes] notes missing schema",{quoteId:a,supabaseError:(0,i.H)(e)}):console.error("[admin quotes] notes query failed",{quoteId:a,supabaseError:(0,i.H)(e)}),b;return c??b}catch(c){return console.error("[admin quotes] notes crashed",{quoteId:a,error:(0,i.H)(c)}),b}}let r=new Set(["quoted","approved"]);function s({quoteId:a,status:b,bidCount:c,hasWinner:d,hasProject:e}){let f="number"==typeof c&&Number.isFinite(c)?c:0,g=!!d,h=r.has(b)&&f>0&&!g;return{quoteId:a,bidCount:f,hasWinner:g,hasProject:!!e,needsDecision:h}}async function t(a){let b=function(a){let b=new Map;for(let c of a??[]){let a=v(c?.quoteId);a&&b.set(a,(0,f.Ao)(c?.status))}return b}(a),c=Array.from(b.keys());if(0===c.length)return{};let e={};for(let[a]of b)e[a]={quoteId:a,bidCount:0,hasWinner:!1,hasProject:!1,needsDecision:!1};let g=[],h=[],j=!1,k=!1;try{let{data:a,error:b}=await d.w9.from("supplier_bids").select("quote_id,status").in("quote_id",c).returns();b?(j=!0,u("meta bids query failed",b)):Array.isArray(a)&&(g=a)}catch(a){j=!0,u("meta bids query crashed",a)}try{let{data:a,error:b}=await d.w9.from("quote_projects").select("quote_id").in("quote_id",c).returns();b?(k=!0,u("meta projects query failed",b)):Array.isArray(a)&&(h=a)}catch(a){k=!0,u("meta projects query crashed",a)}for(let a of g){let b=v(a?.quote_id);b&&e[b]&&(e[b].bidCount+=1,w(a?.status)&&(e[b].hasWinner=!0))}for(let a of new Set(h.map(a=>v(a?.quote_id)).filter(Boolean)))a&&e[a]&&(e[a].hasProject=!0);let l=0,m=0,n=0;for(let[a,c]of b){let b=e[a];if(!b)continue;let d=s({quoteId:a,status:c,bidCount:b.bidCount,hasWinner:b.hasWinner,hasProject:b.hasProject});e[a]=d,d.bidCount>0&&(l+=1),d.hasProject&&(m+=1),d.needsDecision&&(n+=1)}return(0,i.Ro)("meta loaded",{quoteCount:c.length,withBids:l,withProjects:m,needsDecisionCount:n,bidQueryFailed:j||void 0,projectQueryFailed:k||void 0}),e}function u(a,b){let c=(0,i.H)(b);if((0,i.uW)(b))return void(0,i.pU)(a,{supabaseError:c});(0,i.R0)(a,{supabaseError:c})}function v(a){return"string"==typeof a?a.trim():""}function w(a){return"string"==typeof a&&"won"===a.trim().toLowerCase()}async function x(a,b){let c=function(a){let b="string"==typeof a.quoteId?a.quoteId.trim():"";if(!b)return null;let c={};void 0!==a.status&&(c.status=(0,f.Ao)(a.status));let d=function(a){if(void 0!==a){if(null===a)return null;if("number"==typeof a)return Number.isFinite(a)?a:null;if("string"==typeof a){let b=a.trim();if(0===b.length)return null;let c=Number(b);return Number.isFinite(c)?c:null}return null}}(a.price);void 0!==d&&(c.price=d);let e=function(a){let b=z(a);return null==b?b:b.toUpperCase()}(a.currency);void 0!==e&&(c.currency=e);let g=z(a.targetDate);void 0!==g&&(c.target_date=g);let h=z(a.dfmNotes,{preserveCase:!0});void 0!==h&&(c.dfm_notes=h);let i=z(a.internalNotes,{preserveCase:!0});return void 0!==i&&(c.internal_notes=i),{quoteId:b,updates:c}}(a),h=Object.prototype.hasOwnProperty.call(c?.updates??{},"status");if(!c)return(0,i.pU)("update invalid input",{quoteId:a?.quoteId??null}),{ok:!1,error:n};let j=Object.keys(c.updates),k={...c.updates,updated_at:new Date().toISOString()},l=h&&!b?.skipStatusNotifications,m=l?await (0,e.LC)(c.quoteId):null;(0,i.Ro)("update start",{quoteId:c.quoteId,fields:j});try{let{data:a,error:b}=await d.w9.from("quotes").update(k).eq("id",c.quoteId).select("id, upload_id, status").maybeSingle();if(b)return(0,i.uW)(b)?(0,i.pU)("update missing schema",{quoteId:c.quoteId,supabaseError:(0,i.H)(b)}):(0,i.R0)("update failed",{quoteId:c.quoteId,supabaseError:(0,i.H)(b)}),{ok:!1,error:n};if(!a)return(0,i.pU)("update not found",{quoteId:c.quoteId}),{ok:!1,error:n};if((0,i.Ro)("update success",{quoteId:c.quoteId,fields:j}),h&&await y({quoteId:c.quoteId,uploadId:a.upload_id,status:a.status??null}),l&&"string"==typeof c.updates.status){let a=(0,f.Ao)(c.updates.status);(0,g.vT)({quoteId:c.quoteId,status:a,context:m})}return{ok:!0}}catch(a){return(0,i.R0)("update crashed",{quoteId:c.quoteId,supabaseError:(0,i.H)(a)}),{ok:!1,error:n}}}async function y({quoteId:a,uploadId:b,status:c}){if(!b)return void(0,i.gA)("status sync skipped",{quoteId:a,uploadId:null,status:c});try{let{error:e}=await d.w9.from("uploads").update({status:c}).eq("id",b);if(e){let d={quoteId:a,uploadId:b,status:c,supabaseError:(0,i.H)(e)};(0,i.uW)(e)?(0,i.gQ)("status sync missing schema",d):(0,i.gF)("status sync failed",d);return}(0,i.gA)("status sync success",{quoteId:a,uploadId:b,status:c})}catch(d){(0,i.gF)("status sync crashed",{quoteId:a,uploadId:b,status:c,supabaseError:(0,i.H)(d)})}}function z(a,b){if(void 0===a)return;if(null===a||"string"!=typeof a)return null;let c=a.trim();return 0===c.length?null:(b?.preserveCase,c)}}};