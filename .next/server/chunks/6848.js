"use strict";exports.id=6848,exports.ids=[6848],exports.modules={4519:(a,b,c)=>{c.d(b,{QuoteFilesCard:()=>l});var d=c(21124),e=c(38301),f=c(43249);let g=(0,c(13973).default)(async()=>{},{loadableGenerated:{modules:["components/CadViewerClient.tsx -> ./CadViewer"]},ssr:!1,loading:()=>(0,d.jsx)(i,{})});function h(a){return(0,d.jsx)(g,{...a})}function i({height:a=320}){let b="number"==typeof a&&Number.isFinite(a)&&a>0?a:320;return(0,d.jsx)("div",{className:"w-full",children:(0,d.jsx)("div",{className:"relative overflow-hidden rounded-xl border border-slate-900/60 bg-slate-950/60",style:{height:b},children:(0,d.jsx)("div",{className:"flex h-full items-center justify-center px-6 text-center",children:(0,d.jsx)("p",{className:"text-sm text-slate-500",children:"Preparing 3D preview…"})})})})}function j({fileName:a,fileUrl:b,fallbackMessage:c,height:e=360}){return(0,d.jsx)(h,{src:b,fileName:a,fallbackMessage:c,height:e})}var k=c(32999);function l({files:a,id:b,className:c}){let[g,h]=(0,e.useState)(null),i=(0,e.useMemo)(()=>a.find(a=>a.id===g)??null,[g,a]),j=(0,e.useCallback)(()=>{h(null)},[]);return(0,d.jsxs)("section",{id:b,className:(0,f.A)("rounded-2xl border border-slate-800 bg-slate-950/60 px-5 py-4",c),children:[(0,d.jsxs)("div",{className:"flex flex-wrap items-start justify-between gap-3",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("p",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Files"}),(0,d.jsx)("p",{className:"text-sm text-slate-400",children:"Click a file to open the 3D preview modal."})]}),(0,d.jsxs)("span",{className:"text-[11px] font-semibold uppercase tracking-wide text-slate-500",children:[a.length," attached"]})]}),(0,d.jsx)("div",{className:"mt-4 space-y-2",children:0===a.length?(0,d.jsx)("p",{className:"rounded-xl border border-dashed border-slate-900/70 bg-black/20 px-4 py-5 text-sm text-slate-500",children:"No files listed."}):a.map(a=>(0,d.jsxs)("button",{type:"button",onClick:()=>h(a.id),className:"group flex w-full items-center justify-between rounded-xl border border-slate-900/60 bg-slate-950/20 px-4 py-3 text-left transition hover:border-slate-800 hover:bg-slate-900/30 focus-visible:outline focus-visible:outline-2 focus-visible:outline-emerald-400/70",children:[(0,d.jsxs)("div",{className:"min-w-0",children:[(0,d.jsx)("p",{className:"truncate text-sm font-medium text-slate-100",children:a.label}),(0,d.jsx)("p",{className:"mt-0.5 text-xs text-slate-500",children:a.signedUrl?"Interactive STL available":a.fallbackMessage??"Preview not available yet"})]}),(0,d.jsx)("span",{className:(0,f.A)(k.tJ,k.m.sm,"whitespace-nowrap",!a.signedUrl&&"opacity-70"),children:"View model"})]},a.id))}),i&&(0,d.jsx)(m,{file:i,onClose:j})]})}function m({file:a,onClose:b}){let c=(0,e.useRef)(null);return(0,e.useRef)(null),(0,d.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center px-4 py-8",children:[(0,d.jsx)("div",{className:"absolute inset-0 bg-slate-950/80 backdrop-blur-sm",onClick:b,"aria-hidden":"true"}),(0,d.jsxs)("div",{ref:c,role:"dialog","aria-modal":"true","aria-label":`Preview for ${a.label}`,tabIndex:-1,className:"relative z-10 w-full max-w-3xl rounded-3xl border border-slate-800 bg-slate-950/95 shadow-2xl outline-none",children:[(0,d.jsxs)("div",{className:"flex items-start justify-between border-b border-slate-900 px-6 py-4",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("p",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"File preview"}),(0,d.jsx)("h3",{className:"mt-1 text-lg font-semibold text-slate-50",children:a.label})]}),(0,d.jsx)("button",{type:"button",onClick:b,className:"rounded-full border border-slate-800 bg-slate-900/70 p-2 text-slate-400 transition hover:text-slate-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-emerald-400/70","aria-label":"Close preview",children:(0,d.jsx)("svg",{viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",children:(0,d.jsx)("path",{d:"M5 5l10 10M15 5L5 15",stroke:"currentColor",strokeWidth:1.6,strokeLinecap:"round"})})})]}),(0,d.jsx)("div",{className:"px-6 py-6",children:(0,d.jsx)(j,{fileName:a.fileName??a.label,fileUrl:a.signedUrl,fallbackMessage:a.fallbackMessage})}),(0,d.jsx)("div",{className:"flex justify-end gap-3 border-t border-slate-900 px-6 py-4",children:(0,d.jsx)("button",{type:"button",onClick:b,className:(0,f.A)(k.tJ,k.m.sm),children:"Close"})})]})]})}},6173:(a,b,c)=>{c.d(b,{Q:()=>g});var d=c(12831),e=c(31023);let f=process.env.SUPABASE_CAD_BUCKET||process.env.NEXT_PUBLIC_CAD_BUCKET||process.env.NEXT_PUBLIC_SUPABASE_STORAGE_BUCKET||"cad";async function g(a,b){try{let c=b?.includeFilesTable!==!1,f=[];if(c)try{let{data:c,error:g}=await d.w9.from("files").select("storage_path,bucket_id,filename,mime").eq("quote_id",a.id).order("created_at",{ascending:!0});if(g){let c=(0,e.H)(g);(0,e.uW)(g)?console.warn("[admin uploads] files schema missing; treating as zero files",{quoteId:a.id,error:c}):console.error("Failed to load files for quote",{quoteId:a.id,error:c}),b?.onFilesError&&b.onFilesError(g)}else f=c??[]}catch(d){let c=(0,e.H)(d);console.error("Failed to load files for quote",{quoteId:a.id,error:c}),b?.onFilesError&&b.onFilesError(d)}let g=null;if(b&&Object.prototype.hasOwnProperty.call(b,"uploadFileOverride"))g=b?.uploadFileOverride??null;else if(a.upload_id){let{data:b,error:c}=await d.w9.from("uploads").select("file_path,file_name,mime_type").eq("id",a.upload_id).maybeSingle();c?console.error("Failed to load upload for quote",a.upload_id,c):g=b}let j=function(a,b){let c=[];return a?.forEach(a=>{a?.storage_path&&c.push({storagePath:a.storage_path,bucketId:a.bucket_id,fileName:a.filename,mime:a.mime})}),b?.file_path&&c.push({storagePath:b.file_path,bucketId:null,fileName:b.file_name}),c}(f??[],g),k=new Map,l=function(a){let b=[],c=a=>{"string"==typeof a&&a.trim().length>0&&b.push(a.trim())};return[a.file_names,a.upload_file_names].forEach(a=>{Array.isArray(a)&&a.forEach(c)}),0===b.length&&c(a.file_name),b}(a),m=j.map(a=>a.fileName??i(a.storagePath)??null).filter(a=>!!a?.trim()),n=l.length>0?l:m.length>0?m:[],o=[],p=new Set;for(let a=0;a<n.length;a+=1){let b=n[a]||`File ${a+1}`,c=function(a,b){let c=a?.toLowerCase().trim();if(c)return b.find(a=>{let b=a.fileName?.toLowerCase().trim();return!!b&&b===c||(i(a.storagePath)?.toLowerCase().trim()??"")===c})}(b,j);c&&p.add(c.storagePath);let d=c?await h(c,k):{signedUrl:null,fileName:b,reason:"Preview not available for this file yet."};o.push({id:c?.storagePath??`${a}-${b}`,label:b,fileName:d.fileName??b,signedUrl:d.signedUrl,fallbackMessage:d.reason})}for(let[a,b]of j.filter(a=>!p.has(a.storagePath)).entries()){let c=b.fileName??i(b.storagePath)??`File ${o.length+1}`,d=await h(b,k);o.push({id:`${b.storagePath}-${a}`,label:c,fileName:d.fileName??c,signedUrl:d.signedUrl,fallbackMessage:d.reason})}return o}catch(a){return console.error("Unexpected CAD preview error",a),[]}}async function h(a,b){let c,e=`${a.bucketId??"default"}:${a.storagePath}`;if(b.has(e))return b.get(e);if(!function(a){let b=a.fileName?.toLowerCase()??"",c=a.storagePath.toLowerCase(),d=a.mime?.toLowerCase()??"";return b.endsWith(".stl")||c.endsWith(".stl")||d.includes("stl")}(a))return c={signedUrl:null,fileName:a.fileName??i(a.storagePath)??void 0,reason:"Only STL files are supported for preview today."},b.set(e,c),c;let g=function(a,b){if(!a)return null;let c=a.trim().replace(/^\/+/,"");if(!c)return null;let d=b?.trim()||null;return(!d&&c.startsWith(`${f}/`)&&(d=f,c=c.slice(f.length+1)),d||(d=f),c.startsWith(`${d}/`)&&(c=c.slice(d.length+1)),c)?{bucket:d,path:c}:null}(a.storagePath,a.bucketId);if(!g)return c={signedUrl:null,fileName:a.fileName??i(a.storagePath)??void 0,reason:"Missing storage path for CAD file."},b.set(e,c),c;let{data:h,error:j}=await d.w9.storage.from(g.bucket).createSignedUrl(g.path,3600);return j||!h?.signedUrl?(console.error("Failed to create CAD signed URL",j),c={signedUrl:null,fileName:a.fileName??i(a.storagePath)??void 0,reason:"Unable to generate CAD preview link right now."}):c={signedUrl:h.signedUrl,fileName:a.fileName??i(a.storagePath)??void 0},b.set(e,c),c}function i(a){if(!a)return;let b=a.split("/");return b[b.length-1]||void 0}},9965:(a,b,c)=>{c.d(b,{r:()=>e});let d="en-US";function e(a,{includeTime:b=!1,fallback:c="—"}={}){let f=function(a){if(null==a)return null;let b=a instanceof Date?a:new Date(a);return Number.isNaN(b.getTime())?null:b}(a);if(!f)return c;let g=f.toLocaleDateString(d,{month:"short",day:"numeric",year:"numeric"});if(!b)return g;let h=f.toLocaleTimeString(d,{hour:"numeric",minute:"2-digit"});return`${g} \xb7 ${h}`}},16616:(a,b,c)=>{c.d(b,{Sy:()=>d.Sy,_K:()=>d._K});var d=c(43474)},26303:(a,b,c)=>{c.d(b,{l:()=>g,r:()=>f});let d="en-US";function e(a){if(null==a)return null;let b=a instanceof Date?a:new Date(a);return Number.isNaN(b.getTime())?null:b}function f(a,{includeTime:b=!1,fallback:c="—"}={}){let g=e(a);if(!g)return c;let h=g.toLocaleDateString(d,{month:"short",day:"numeric",year:"numeric"});if(!b)return h;let i=g.toLocaleTimeString(d,{hour:"numeric",minute:"2-digit"});return`${h} \xb7 ${i}`}function g(a){let b=e(a);return b?b.toISOString().slice(0,10):""}},37331:(a,b,c)=>{c.d(b,{QuoteFilesCard:()=>d});let d=(0,c(97954).registerClientReference)(function(){throw Error("Attempted to call QuoteFilesCard() from the server but QuoteFilesCard is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/workspace/src/app/admin/quotes/[id]/QuoteFilesCard.tsx","QuoteFilesCard")},41510:(a,b,c)=>{c.d(b,{Y:()=>k,x:()=>l});var d=c(12831),e=c(31023),f=c(40257);let g="quote_projects",h="id,quote_id,po_number,target_ship_date,notes,created_at,updated_at",i="Project details are unavailable right now. Please try again.",j="We couldn’t update the project details. Please retry.";async function k(a){let b=o(a);if(!b)return{ok:!1,data:null,error:"quoteId is required",unavailable:!0};try{let{data:a,error:c}=await d.w9.from(g).select(h).eq("quote_id",b).maybeSingle();if(c){let a=(0,e.H)(c);if((0,e.uW)(c))return console.warn("[quote projects] load missing schema",{quoteId:b,error:a}),m(b,i);return console.error("[quote projects] load failed",{quoteId:b,error:a}),m(b,i)}let f=a??null;return n(b,f,!1),{ok:!0,data:f,error:null,unavailable:!1}}catch(c){let a=(0,e.H)(c);if((0,e.uW)(c))return console.warn("[quote projects] load crashed (missing schema)",{quoteId:b,error:a}),m(b,i);return console.error("[quote projects] load crashed",{quoteId:b,error:a??c}),m(b,i)}}async function l(a){let b=o(a?.quoteId),c=function(a){if("string"!=typeof a)return null;let b=a.trim();return b?b.slice(0,100):null}(a?.poNumber),i=function(a){if("string"!=typeof a)return null;let b=a.trim();return b&&p.test(b)?b:null}(a?.targetShipDate),k=function(a){if("string"!=typeof a)return null;let b=a.trim();return b?b.slice(0,2e3):null}(a?.notes);if(!b)return{ok:!1,data:null,error:j};let l=!1;try{let{data:a,error:c}=await d.w9.from(g).select("id").eq("quote_id",b).maybeSingle();c&&!(0,e.uW)(c)&&console.warn("[quote projects] existing lookup failed",{quoteId:b,error:(0,e.H)(c)}),l=!!a?.id}catch(a){console.warn("[quote projects] existing lookup crashed",{quoteId:b,error:(0,e.H)(a)})}console.log("[quote projects] upsert start",{quoteId:b,hasPoNumber:!!c,hasTargetDate:!!i});try{let a={quote_id:b,po_number:c,target_ship_date:i,notes:k,updated_at:new Date().toISOString()},{data:m,error:n}=await d.w9.from(g).upsert(a,{onConflict:"quote_id"}).select(h).single();if(n||!m){let a=(0,e.H)(n);return(0,e.uW)(n)?console.warn("[quote projects] upsert missing schema",{quoteId:b,error:a}):console.error("[quote projects] upsert failed",{quoteId:b,error:a}),{ok:!1,data:null,error:j}}return console.log("[quote projects] upsert success",{quoteId:b}),(0,f.X1)({quoteId:b,project:m,created:!l}),{ok:!0,data:m,error:null}}catch(c){let a=(0,e.H)(c);return(0,e.uW)(c)?console.warn("[quote projects] upsert crashed (missing schema)",{quoteId:b,error:a}):console.error("[quote projects] upsert crashed",{quoteId:b,error:a??c}),{ok:!1,data:null,error:j}}}function m(a,b){return n(a,null,!0),{ok:!1,data:null,error:b,unavailable:!0}}function n(a,b,c){a&&console.info("[quote projects] load result",{quoteId:a,hasProject:!!b,unavailable:c})}function o(a){return"string"==typeof a?a.trim():""}let p=/^\d{4}-\d{2}-\d{2}$/},81320:(a,b,c)=>{c.d(b,{go:()=>g,xF:()=>f});var d=c(12831);let e="id,quote_id,author_type,author_name,author_email,body,created_at";async function f(a){let b="string"==typeof a?a.trim():"";if(!b)return{ok:!1,data:null,error:"quoteId is required"};console.log("[quote messages] load start",{quoteId:b});try{let{data:a,error:c}=await d.w9.from("quote_messages").select(e).eq("quote_id",b).order("created_at",{ascending:!0});if(c)return console.error("[quote messages] load failed",{quoteId:b,error:c}),{ok:!1,data:null,error:"Unable to load messages right now."};let f=a??[];return console.log("[quote messages] load result",{quoteId:b,count:f.length}),{ok:!0,data:f,error:null}}catch(a){return console.error("[quote messages] load crashed",{quoteId:b,error:a}),{ok:!1,data:null,error:"Unable to load messages right now."}}}async function g({quoteId:a,body:b,authorType:c,authorName:f,authorEmail:g}){var h;let i="string"==typeof a?a.trim():"",j=function(a){if("string"!=typeof a)return null;let b=a.trim();return b?b.length>2e3?b.slice(0,2e3):b:null}(b),k="admin"===(h=c)||"customer"===h||"supplier"===h?h:null,l=function(a){if("string"!=typeof a)return null;let b=a.trim().slice(0,120);return b.length>0?b:null}(f),m=function(a){if("string"!=typeof a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}(g);if(!i||!j||!k)return console.error("[quote messages] create failed",{quoteId:a,authorType:c,reason:"invalid-input"}),{ok:!1,data:null,error:"Missing required message fields."};console.log("[quote messages] create start",{quoteId:i,authorType:k});try{let{data:a,error:b}=await d.w9.from("quote_messages").insert({quote_id:i,author_type:k,author_name:l,author_email:m,body:j}).select(e).single();if(b||!a)return console.error("[quote messages] create failed",{quoteId:i,authorType:k,error:b}),{ok:!1,data:null,error:"Failed to post message."};return console.log("[quote messages] create success",{quoteId:i,authorType:k,messageId:a.id}),{ok:!0,data:a,error:null}}catch(a){return console.error("[quote messages] create crashed",{quoteId:i,authorType:k,error:a}),{ok:!1,data:null,error:"Failed to post message."}}}},88437:(a,b,c)=>{c.d(b,{QuoteWorkspaceTabs:()=>g});var d=c(21124),e=c(38301),f=c(43249);function g({tabs:a,defaultTab:b="summary"}){let c=(0,e.useId)(),[g,h]=(0,e.useState)(a.find(a=>a.id===b)?.id??a[0]?.id??"summary"),i=(0,e.useMemo)(()=>a.filter((a,b,c)=>a&&"string"==typeof a.id&&c.findIndex(b=>b.id===a.id)===b),[a]);return 0===i.length?null:(0,d.jsxs)("div",{className:"space-y-5",children:[(0,d.jsx)("div",{className:"overflow-x-auto pb-1",children:(0,d.jsx)("div",{className:"flex min-w-max gap-2",role:"tablist","aria-label":"Quote workspace navigation",children:i.map(a=>{let b=a.id===g,e=`${c}-tab-${a.id}`,i=`${c}-panel-${a.id}`;return(0,d.jsxs)("button",{id:e,type:"button",role:"tab","aria-selected":b,"aria-controls":i,onClick:()=>h(a.id),className:(0,f.A)("rounded-full border px-3 py-1 text-xs font-semibold transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400",b?"border-emerald-400 bg-emerald-500/20 text-emerald-100 shadow-[0_0_25px_rgba(16,185,129,0.25)]":"border-slate-800 bg-slate-900/70 text-slate-300 hover:border-emerald-400 hover:text-emerald-100"),children:[(0,d.jsx)("span",{children:a.label}),"number"==typeof a.count&&(0,d.jsx)("span",{className:(0,f.A)("ml-2 rounded-full border px-2 py-0.5 text-[10px]",b?"border-transparent bg-slate-900/40 text-emerald-100/80":"border-slate-800 bg-slate-950/70 text-slate-400"),children:a.count})]},a.id)})})}),(0,d.jsx)("div",{children:i.map(a=>{let b=a.id===g,e=`${c}-panel-${a.id}`,h=`${c}-tab-${a.id}`;return(0,d.jsx)("div",{id:e,role:"tabpanel","aria-labelledby":h,className:(0,f.A)("space-y-4",b?"block":"hidden"),"aria-hidden":!b,children:a.content},a.id)})})]})}},98719:(a,b,c)=>{c.d(b,{QuoteWorkspaceTabs:()=>d});let d=(0,c(97954).registerClientReference)(function(){throw Error("Attempted to call QuoteWorkspaceTabs() from the server but QuoteWorkspaceTabs is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/workspace/src/app/admin/quotes/[id]/QuoteWorkspaceTabs.tsx","QuoteWorkspaceTabs")}};