"use strict";exports.id=8023,exports.ids=[8023],exports.modules={897:(a,b,c)=>{c.d(b,{j1:()=>g,z1:()=>h});var d=c(65844),e=c(23867);let f=new Set(e.Hk);function g(a,b,c){let e=(0,d.u_)(b);return!!e&&!!c&&("customer"===a?function(a,b){if(i([b.email,b.customer_email,...b.customerEmails??[],...b.allowedCustomerEmails??[]]).has(a))return!0;let c=a.split("@")[1];return!!c&&(function(a){let b=new Set;return a.forEach(a=>{if(!a)return;let c=a.trim().toLowerCase().replace(/^@/,"");c.includes(".")&&b.add(c)}),b})([b.customerDomain,b.orgDomain,...b.allowedCustomerDomains??[]]).has(c)}(e,c):"supplier"===a&&function(a,b){if(i([b.assigned_supplier_email,b.assignedSupplierEmail,...b.allowedSupplierEmails??[],...j(b.assignments),...j(b.supplierAssignments)]).has(a))return!0;let c=i(b.supplierContext?.verifiedEmails??[]);if(b.supplierContext?.verifiedAccess&&c.has(a))return!0;let e=(0,d.u_)(b.email??null);return!!e&&e===a}(e,c))}function h(a,b){var c;if("supplier"!==a||!b||!1===b.accessGranted||!1===b.allowBids||!0===b.bidLocked)return!1;let d=(0,e.Ao)(b.status);return!!f.has(d)&&"accepted"!==((c=b.existingBidStatus)?c.trim().toLowerCase():null)}function i(a){let b=new Set;return a.forEach(a=>{let c=(0,d.u_)(a??null);c&&b.add(c)}),b}function j(a){return a&&0!==a.length?a.map(a=>a?.supplier_email??a?.email??null):[]}},23696:(a,b,c)=>{c.d(b,{Ef:()=>e}),"true"===process.env.SUPPLIER_ASSIGNMENTS_ENABLED||process.env.NEXT_PUBLIC_SUPPLIER_ASSIGNMENTS_ENABLED;let d="true"===process.env.SUPPLIER_APPROVALS_ENABLED||"true"===process.env.NEXT_PUBLIC_SUPPLIER_APPROVALS_ENABLED;function e(){return d}},48023:(a,b,c)=>{c.d(b,{Pl:()=>e.Pl,fd:()=>d.fd,wN:()=>e.wN,jp:()=>d.jp,WP:()=>d.WP,m9:()=>d.m9,KP:()=>d.KP,ZS:()=>d.ZS,G_:()=>d.G_,rs:()=>d.rs});var d=c(31722),e=c(71564);c(50904),c(897),c(23696),c(23867),c(15656)},65844:(a,b,c)=>{c.d(b,{u_:()=>d});function d(a){if(!a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}},71564:(a,b,c)=>{c.d(b,{Pl:()=>u,wN:()=>v,Sy:()=>s,qn:()=>t});var d=c(50904),e=c(15656),f=c(31722);c(23696);var g=c(52453),h=c(23867),i=c(51739);[...c(85150).L];let j="Unable to update this quote right now. Please try again.";async function k(a,b){let c=function(a){let b="string"==typeof a.quoteId?a.quoteId.trim():"";if(!b)return null;let c={};void 0!==a.status&&(c.status=(0,h.Ao)(a.status));let d=function(a){if(void 0!==a){if(null===a)return null;if("number"==typeof a)return Number.isFinite(a)?a:null;if("string"==typeof a){let b=a.trim();if(0===b.length)return null;let c=Number(b);return Number.isFinite(c)?c:null}return null}}(a.price);void 0!==d&&(c.price=d);let e=function(a){let b=m(a);return null==b?b:b.toUpperCase()}(a.currency);void 0!==e&&(c.currency=e);let f=m(a.targetDate);void 0!==f&&(c.target_date=f);let g=m(a.dfmNotes,{preserveCase:!0});void 0!==g&&(c.dfm_notes=g);let i=m(a.internalNotes,{preserveCase:!0});return void 0!==i&&(c.internal_notes=i),{quoteId:b,updates:c}}(a),f=Object.prototype.hasOwnProperty.call(c?.updates??{},"status");if(!c)return(0,e.pU)("update invalid input",{quoteId:a?.quoteId??null}),{ok:!1,error:j};let k=Object.keys(c.updates),n={...c.updates,updated_at:new Date().toISOString()},o=f&&!b?.skipStatusNotifications,p=o?await (0,g.LC)(c.quoteId):null;(0,e.Ro)("update start",{quoteId:c.quoteId,fields:k});try{let{data:a,error:b}=await d.w9.from("quotes").update(n).eq("id",c.quoteId).select("id, upload_id, status").maybeSingle();if(b)return(0,e.uW)(b)?(0,e.pU)("update missing schema",{quoteId:c.quoteId,supabaseError:(0,e.H)(b)}):(0,e.R0)("update failed",{quoteId:c.quoteId,supabaseError:(0,e.H)(b)}),{ok:!1,error:j};if(!a)return(0,e.pU)("update not found",{quoteId:c.quoteId}),{ok:!1,error:j};if((0,e.Ro)("update success",{quoteId:c.quoteId,fields:k}),f&&await l({quoteId:c.quoteId,uploadId:a.upload_id,status:a.status??null}),o&&"string"==typeof c.updates.status){let a=(0,h.Ao)(c.updates.status);(0,i.vT)({quoteId:c.quoteId,status:a,context:p})}return{ok:!0}}catch(a){return(0,e.R0)("update crashed",{quoteId:c.quoteId,supabaseError:(0,e.H)(a)}),{ok:!1,error:j}}}async function l({quoteId:a,uploadId:b,status:c}){if(!b)return void(0,e.gA)("status sync skipped",{quoteId:a,uploadId:null,status:c});try{let{error:f}=await d.w9.from("uploads").update({status:c}).eq("id",b);if(f){let d={quoteId:a,uploadId:b,status:c,supabaseError:(0,e.H)(f)};(0,e.uW)(f)?(0,e.gQ)("status sync missing schema",d):(0,e.gF)("status sync failed",d);return}(0,e.gA)("status sync success",{quoteId:a,uploadId:b,status:c})}catch(d){(0,e.gF)("status sync crashed",{quoteId:a,uploadId:b,status:c,supabaseError:(0,e.H)(d)})}}function m(a,b){if(void 0===a)return;if(null===a||"string"!=typeof a)return null;let c=a.trim();return 0===c.length?null:(b?.preserveCase,c)}let n="supplier_bids",o="Bids are not available in this environment.",p="We had trouble loading bids.",q="We couldn't select that bid. Please check logs and try again.",r="id,quote_id,supplier_id,unit_price,currency,lead_time_days,notes,status,created_at,updated_at";async function s(a,b){if(!a||!b)return{ok:!1,data:null,error:"Supplier and quote are required."};try{let{data:c,error:f}=await d.w9.from(n).select(r).eq("quote_id",b).eq("supplier_id",a).maybeSingle();if(f){let c=(0,e.H)(f);if((0,e.uW)(f))return console.warn("[bids] detail missing schema",{supplierId:a,quoteId:b,error:c}),{ok:!1,data:null,error:o};return console.error("[bids] detail query failed",{supplierId:a,quoteId:b,error:c}),{ok:!1,data:null,error:p}}return{ok:!0,data:w(c),error:null}}catch(d){let c=(0,e.H)(d);if((0,e.uW)(d))return console.warn("[bids] detail missing schema",{supplierId:a,quoteId:b,error:c}),{ok:!1,data:null,error:o};return console.error("[bids] detail crashed",{supplierId:a,quoteId:b,error:c??d}),{ok:!1,data:null,error:p}}}async function t(a){let b="string"==typeof a?.quoteId?a.quoteId.trim():"",c="string"==typeof a?.bidId?a.bidId.trim():"";if(!b||!c)return console.warn("[bids] winner selection missing identifiers",{quoteId:b,bidId:c}),{ok:!1,error:q};try{let{data:a,error:f}=await d.w9.from(n).select(r).eq("id",c).maybeSingle();if(f){let a=(0,e.H)(f);if((0,e.uW)(f))return console.warn("[bids] winner lookup missing schema",{quoteId:b,bidId:c,error:a}),{ok:!1,error:o};return console.error("[bids] winner lookup failed",{quoteId:b,bidId:c,error:a}),{ok:!1,error:q}}if(!a||a.quote_id!==b)return console.warn("[bids] winner lookup mismatch",{quoteId:b,bidId:c,bidQuoteId:a?.quote_id??null}),{ok:!1,error:q};let g=w(a);if(!g)return console.error("[bids] winner normalize failed",{quoteId:b,bidId:c}),{ok:!1,error:q};let h=new Date().toISOString(),{error:i}=await d.w9.from(n).update({status:"won",updated_at:h}).eq("id",c);if(i){let a=(0,e.H)(i);if((0,e.uW)(i))return console.warn("[bids] winner update missing schema",{quoteId:b,bidId:c,error:a}),{ok:!1,error:o};return console.error("[bids] winner update failed",{quoteId:b,bidId:c,error:a}),{ok:!1,error:q}}let{error:l}=await d.w9.from(n).update({status:"lost",updated_at:h}).eq("quote_id",b).neq("id",c);l&&console.warn("[bids] losing peer bids failed",{quoteId:b,bidId:c,error:(0,e.H)(l)});let m="number"==typeof g.amount&&Number.isFinite(g.amount)?g.amount:null,p="string"==typeof g.currency&&g.currency.trim().length>0?g.currency.trim().toUpperCase():"USD",s=await k({quoteId:b,status:"won",price:m,currency:p},{skipStatusNotifications:!0});if(!s.ok)return(0,e.R0)("winner update failed",{quoteId:b,bidId:c,error:s.error}),{ok:!1,error:s.error??j};return(0,e.Ro)("winner update success",{quoteId:b,bidId:c,price:m,currency:p}),console.log("[bids] winner selected",{quoteId:b,bidId:c}),{ok:!0,error:null}}catch(d){let a=(0,e.H)(d);if((0,e.uW)(d))return console.warn("[bids] winner selection missing schema",{quoteId:b,bidId:c,error:a}),{ok:!1,error:o};return console.error("[bids] winner selection crashed",{quoteId:b,bidId:c,error:a??d}),{ok:!1,error:q}}}async function u(a,b){if(!a||!b)throw Error("bidId and quoteId are required");try{let c=await x(a);if(!c||c.quote_id!==b)return console.error("acceptSupplierBidForQuote: mismatched bid/quote",{bidId:a,quoteId:b}),{accepted:null};let e=new Date().toISOString(),{data:g,error:h}=await d.w9.from("supplier_bids").update({status:"accepted",updated_at:e}).eq("id",a).select("*").maybeSingle();if(h||!g)return console.error("acceptSupplierBidForQuote: accept update failed",{bidId:a,quoteId:b,error:h}),{accepted:null};let{error:i}=await d.w9.from("supplier_bids").update({status:"declined",updated_at:e}).eq("quote_id",b).neq("id",a);i&&console.error("acceptSupplierBidForQuote: declining peers failed",{quoteId:b,error:i});let j=await (0,f.n1)(g.supplier_id);return j&&await y(b,j),{accepted:g}}catch(c){throw console.error("acceptSupplierBidForQuote: unexpected error",{bidId:a,quoteId:b,error:c}),c}}async function v(a,b){if(!a)return null;try{let c=await x(a);if(!c)return null;let{data:e,error:f}=await d.w9.from("supplier_bids").update({status:"declined",updated_at:new Date().toISOString()}).eq("id",a).select("*").maybeSingle();if(f)return console.error("declineSupplierBid: update failed",{bidId:a,error:f}),null;return b&&"accepted"===c.status&&await d.w9.from("quotes").update({assigned_supplier_email:null,assigned_supplier_name:null,updated_at:new Date().toISOString()}).eq("id",b),e??null}catch(c){return console.error("declineSupplierBid: unexpected error",{bidId:a,quoteId:b,error:c}),null}}function w(a){return a?{id:a.id,quote_id:a.quote_id,supplier_id:a.supplier_id,amount:function(a){let b="string"==typeof a?Number(a):a;return"number"==typeof b&&Number.isFinite(b)?b:null}(a.unit_price),currency:a.currency??null,lead_time_days:"number"==typeof a.lead_time_days&&Number.isFinite(a.lead_time_days)?a.lead_time_days:null,notes:a.notes??null,status:a.status??null,created_at:a.created_at??null,updated_at:a.updated_at??null}:null}async function x(a){if(!a)return null;let{data:b,error:c}=await d.w9.from("supplier_bids").select("*").eq("id",a).maybeSingle();return c?(console.error("getBidById: lookup failed",{bidId:a,error:c}),null):b??null}async function y(a,b){try{let{error:c}=await d.w9.from("quotes").update({assigned_supplier_email:b.primary_email,assigned_supplier_name:b.company_name,updated_at:new Date().toISOString()}).eq("id",a);c&&console.error("updateQuoteAssignedSupplier: quote update failed",{quoteId:a,supplierId:b.id,error:c})}catch(c){console.error("updateQuoteAssignedSupplier: unexpected error",{quoteId:a,supplierId:b.id,error:c})}}},85150:(a,b,c)=>{c.d(b,{L:()=>d});let d=["id","upload_id","customer_name","email","company","status","price","currency","created_at","updated_at","target_date","file_name"]}};