"use strict";exports.id=130,exports.ids=[130],exports.modules={3440:(a,b,c)=>{c.d(b,{j1:()=>g,z1:()=>h});var d=c(64811),e=c(33358);let f=new Set(e.Hk);function g(a,b,c){let e=(0,d.u_)(b);return!!e&&!!c&&("customer"===a?function(a,b){if(i([b.email,b.customer_email,...b.customerEmails??[],...b.allowedCustomerEmails??[]]).has(a))return!0;let c=a.split("@")[1];return!!c&&(function(a){let b=new Set;return a.forEach(a=>{if(!a)return;let c=a.trim().toLowerCase().replace(/^@/,"");c.includes(".")&&b.add(c)}),b})([b.customerDomain,b.orgDomain,...b.allowedCustomerDomains??[]]).has(c)}(e,c):"supplier"===a&&function(a,b){if(i([b.assigned_supplier_email,b.assignedSupplierEmail,...b.allowedSupplierEmails??[],...j(b.assignments),...j(b.supplierAssignments)]).has(a))return!0;let c=i(b.supplierContext?.verifiedEmails??[]);if(b.supplierContext?.verifiedAccess&&c.has(a))return!0;let e=(0,d.u_)(b.email??null);return!!e&&e===a}(e,c))}function h(a,b){var c;if("supplier"!==a||!b||!1===b.accessGranted||!1===b.allowBids||!0===b.bidLocked)return!1;let d=(0,e.Ao)(b.status);return!!f.has(d)&&"accepted"!==((c=b.existingBidStatus)?c.trim().toLowerCase():null)}function i(a){let b=new Set;return a.forEach(a=>{let c=(0,d.u_)(a??null);c&&b.add(c)}),b}function j(a){return a&&0!==a.length?a.map(a=>a?.supplier_email??a?.email??null):[]}},64811:(a,b,c)=>{async function d(a){if(void 0!==a)return await a}function e(a,b){var c;if(!a)return;if(c=a,"function"==typeof c?.get)return a.get(b)??void 0;let d=a[b];return Array.isArray(d)?d[0]:d}function f(a){if(!a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}function g(a){return a?a.startsWith("Q-")?a:`#${a.slice(0,6)}`:"Quote"}function h(a){return Array.isArray(a)?a[0]:a??void 0}c.d(b,{Ol:()=>d,VC:()=>e,nb:()=>h,u_:()=>f,xt:()=>g})},90130:(a,b,c)=>{c.d(b,{Pl:()=>e.Pl,wN:()=>e.wN,WP:()=>d.WP,g1:()=>e.g1,KF:()=>d.KF,w0:()=>w,sh:()=>y,KP:()=>d.KP,ZS:()=>d.ZS,_r:()=>l});var d=c(49669),e=c(43474),f=c(12831),g=c(2254),h=c(25049),i=c(3440),j=c(28503),k=c(33358);async function l(a){let b=a.supplierId??null,c=q(a.supplierEmail),e={supplierId:b,supplierEmail:c,loader:"matches"};if(!b)return console.warn("[supplier activity] loading skipped",{...e,error:"Missing supplier identity"}),{ok:!1,data:[],error:"Missing supplier identity"};console.log("[supplier activity] loading",e);try{let a=await (0,d.n1)(b);if(!a)return console.warn("[supplier activity] loading skipped",{...e,error:"Supplier profile missing"}),{ok:!1,data:[],error:"Supplier profile missing"};let f={supplierId:a.id,supplierEmail:a.primary_email??c},g=(0,d.WP)(a),h=(0,j.Ef)(),l=!h||(0,d.m9)(a);if(h&&!l)return m("supplier skipped - not approved",{...f,approvalStatus:g,approvalsEnabled:h,supplierApproved:l}),console.log("[supplier activity] approvals gate active",{...e,approvalStatus:g}),{ok:!0,data:[],approvalGate:{enabled:!0,status:g}};let[q,v,w]=await Promise.all([(0,d.n8)(a.id),t(a.primary_email),u(a.id)]),x=n(q);if(0===x.processes.size)return m("supplier skipped - capability mismatch",{...f,reason:"No manufacturing processes recorded"}),console.log("[supplier activity] quote query result",{...e,count:0}),{ok:!0,data:[]};let y=new Set;v.forEach(a=>{a?.quote_id&&y.add(a.quote_id)}),w.forEach(a=>{a?.quote_id&&y.add(a.quote_id)});let z=a.verified||h&&l,A=await r();if(0===A.length)return console.log("[supplier activity] quote query result",{...e,count:0}),{ok:!0,data:[]};let B=await s(A),C=function(a){let b=0,c=[];a.assignmentCount<=2?(b+=1,c.push("Boosted because this supplier hasn’t been overexposed yet.")):a.assignmentCount>=8&&(b-=.5,c.push("Slight penalty to avoid routing everything to the same shop."));let d=a.recentBidOutcomes.filter(a=>{if(!a.status||"accepted"===a.status)return!1;let b=Date.parse(a.updated_at??"");return!Number.isNaN(b)&&(Date.now()-b)/864e5<=30}).length;return d>0&&(b+=Math.min(1.2,.3*d),c.push("Extra weight because they’ve been responding recently without being selected.")),0===a.recentBidOutcomes.length&&(b+=.4,c.push("New to bidding — giving them a gentle nudge into rotation.")),function(a){if(!a)return!1;let b=Date.parse(a);return!Number.isNaN(b)&&(Date.now()-b)/864e5<=45}(a.supplierCreatedAt)&&(b+=.8,c.push("Recently onboarded supplier gets a temporary boost.")),{modifier:b,reasons:c}}({assignmentCount:v.length,recentBidOutcomes:w,supplierCreatedAt:a.created_at}),D=[];for(let b of A){let c=b.id,d=b.status??null,e={...f,quoteId:c,quoteStatus:d};if(!(0,k.Bg)(d)){m("supplier skipped - RFQ not open",e);continue}let g=b.upload_id?B.get(b.upload_id):null,j=g?.manufacturing_process??null,n=o(j);if(!(n&&p(n,x.processes))){m("supplier skipped - capability mismatch",{...e,processHint:j});continue}let q=z||!!c&&y.has(c);if(!q){m("supplier skipped - supplier inactive",{...e,approvalsEnabled:h,supplierApproved:l,supplierVerified:a.verified,reason:a.verified?"supplier not assigned to RFQ":"supplier not verified for global feed"});continue}let r=w.find(a=>a.quote_id===c);if(!(0,i.z1)("supplier",{status:b.status,existingBidStatus:r?.status??null,accessGranted:q})){m("supplier skipped - bidding blocked",{...e,existingBidStatus:r?.status??null,reason:"permission matrix denied bidding"});continue}let s=function(a,b){if(!a||0===b.size)return[];let c=[a.notes??"",a.rfq_reason??""].join(" ").toLowerCase(),d=[];return b.forEach(a=>{0!==a.length&&c.includes(a)&&d.push(a)}),d}(g,x.materials),t=function({createdAt:a,materialMatches:b}){let c;if(c=1+.5*b.length,a){let b=Date.parse(a);Number.isNaN(b)||(c+=Math.max(0,30-(Date.now()-b)/864e5)/10)}return c}({createdAt:b.created_at,materialMatches:s})+C.modifier;if(D.push({quoteId:c,quote:b,processHint:j,materialMatches:s,score:t,createdAt:b.created_at??null,quantityHint:g?.quantity??null,fairness:C.reasons.length>0?C:void 0}),m("supplier matched",{...e,processHint:j,score:t}),D.length>=20)break}let E=D.sort((a,b)=>b.score-a.score);return console.log("[supplier activity] quote query result",{...e,count:E.length}),{ok:!0,data:E}}catch(a){return(0,g.aH)({...e,query:(0,g.qr)(a,"matchQuotesToSupplier"),error:a}),{ok:!1,data:[],error:"Unable to load matches right now"}}}function m(a,b){console.log(`[matching] ${a}`,b)}function n(a){let b=new Set,c=new Set;return a.forEach(a=>{let d=o(a.process);d&&b.add(d),(a.materials??[]).forEach(a=>{let b=function(a){if("string"!=typeof a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}(a);b&&c.add(b)})}),{processes:b,materials:c}}function o(a){if("string"!=typeof a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}function p(a,b){if(b.has(a))return!0;for(let c of b)if(a.includes(c)||c.includes(a))return!0;return!1}function q(a){if("string"!=typeof a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}async function r(){try{let{data:a,error:b}=await f.w9.from("quotes_with_uploads").select(h.L.join(",")).in("status",Array.from(k.Hk)).order("created_at",{ascending:!1}).limit(50);if(b)throw(0,g.n0)("quotes_with_uploads",b);return a??[]}catch(a){throw(0,g.n0)("quotes_with_uploads",a)}}async function s(a){let b=Array.from(new Set(a.map(a=>a.upload_id).filter(a=>"string"==typeof a&&a.length>0)));if(0===b.length)return new Map;try{let{data:a,error:c}=await f.w9.from("uploads").select("id,manufacturing_process,quantity,rfq_reason,notes").in("id",b);if(c)throw(0,g.n0)("uploads",c);let d=new Map;return(a??[]).forEach(a=>{a?.id&&d.set(a.id,a)}),d}catch(a){throw(0,g.n0)("uploads",a)}}async function t(a){if(!a)return[];try{let{data:b,error:c}=await f.w9.from("quote_suppliers").select("quote_id").eq("supplier_email",a);if(c)throw(0,g.n0)("quote_suppliers",c);return b??[]}catch(a){throw(0,g.n0)("quote_suppliers",a)}}async function u(a){if(!a)return[];try{let{data:b,error:c}=await f.w9.from("supplier_bids").select("quote_id,status,updated_at").eq("supplier_id",a);if(c)throw(0,g.n0)("supplier_bids",c);return b??[]}catch(a){throw(0,g.n0)("supplier_bids",a)}}var v=c(31023);async function w(a,b){let c="string"==typeof a?a.trim():"";if(!c)return{};let d=Array.from(new Set((b??[]).map(a=>"string"==typeof a?a.trim():"").filter(a=>a.length>0)));if(0===d.length)return{};try{let{data:a,error:b}=await f.w9.from("supplier_bids").select("quote_id,status,created_at,updated_at").eq("supplier_id",c).in("quote_id",d).returns();if(b)return console.error("[supplier inbox] failed to load bid aggregates",{supplierId:c,quoteCount:d.length,error:(0,v.H)(b)}),{};let e={};for(let b of a??[]){let a=function(a){if("string"!=typeof a)return null;let b=a.trim();return b.length>0?b:null}(b?.quote_id);if(!a)continue;let c=e[a]??{quoteId:a,bidCount:0,lastBidAt:null,hasWinningBid:!1},d=function(a,b){let c=x(a),d=x(b);return c&&d?c>d?c:d:c??d??null}(b?.updated_at,b?.created_at);e[a]={quoteId:a,bidCount:c.bidCount+1,lastBidAt:!c.lastBidAt||d&&d>c.lastBidAt?d??c.lastBidAt:c.lastBidAt,hasWinningBid:c.hasWinningBid||function(a){if(!a)return!1;let b=a.trim().toLowerCase();return"won"===b||"winner"===b||"approved"===b}(b?.status??null)}}return console.info("[supplier inbox] bid aggregates loaded",{supplierId:c,quoteCount:d.length,withBids:Object.keys(e).length}),e}catch(a){return console.error("[supplier inbox] bid aggregates crashed",{supplierId:c,quoteCount:d.length,error:(0,v.H)(a)??a??null}),{}}}function x(a){if("string"!=typeof a)return null;let b=a.trim();return b.length>0?b:null}async function y(a,b){var c,e;let f="string"==typeof a?a.trim():"",g="number"!=typeof(c=b?.lookbackDays)||!Number.isFinite(c)||c<=0?30:Math.min(90,Math.round(c)),h={supplierId:f,evaluatedCount:0,matchedCount:0,skippedCapabilityCount:0,recentExamples:[]};if(!f)return h;let k=(e=g,new Date(Date.now()-24*Math.max(1,e)*36e5).toISOString());try{let a=await (0,d.n1)(f);if(!a)return console.warn("[supplier match] health skipped",{supplierId:f,lookbackDays:g,reason:"Supplier profile missing"}),h;let b=q(a.primary_email??null),c=(0,j.Ef)(),e=!c||(0,d.m9)(a),[l,m,r,s]=await Promise.all([(0,d.n8)(a.id),b?t(b):[],u(a.id),z(k)]),v=n(l);if(0===v.processes.size||0===s.length)return console.log("[supplier match] health loaded",{supplierId:a.id,evaluatedCount:0,matchedCount:0,skippedCapabilityCount:0,lookbackDays:g}),{...h,supplierId:a.id};let w=await A(s),x=function(a,b){let c=new Set;return a.forEach(a=>{let b="string"==typeof a?.quote_id&&a.quote_id.length>0?a.quote_id:null;b&&c.add(b)}),b.forEach(a=>{let b="string"==typeof a?.quote_id&&a.quote_id.length>0?a.quote_id:null;b&&c.add(b)}),c}(m,r),y=function(a){let b=new Map;return a.forEach(a=>{let c="string"==typeof a?.quote_id&&a.quote_id.length>0?a.quote_id:null;c&&b.set(c,{status:a?.status??null})}),b}(r),B=a.verified||c&&e,C=0,D=0,E=0,F=[];for(let a of s){let b="string"==typeof a.id?a.id:null;if(!b)continue;let c="string"==typeof a.upload_id&&a.upload_id.length>0?w.get(a.upload_id)??null:null,d=o(c);if(!d)continue;let e=p(d,v.processes),f={quoteId:b,status:a.status??null,processHint:c,createdAt:a.created_at??null};if(!e){E+=1,C+=1,F.push({...f,outcome:"skipped_capability"});continue}if(!(B||b&&x.has(b)))continue;let g=y.get(b);(0,i.z1)("supplier",{status:a.status,existingBidStatus:g?.status??null,accessGranted:!0})&&(D+=1,C+=1,F.push({...f,outcome:"matched"}))}let G=function(a,b){if(!Array.isArray(a)||0===a.length)return[];let c=Math.max(1,3);return[...a].sort((a,b)=>{let c=a.createdAt?Date.parse(a.createdAt):0;return(b.createdAt?Date.parse(b.createdAt):0)-c}).slice(0,c).map(a=>({quoteId:a.quoteId,status:a.status??null,processHint:a.processHint??null,outcome:a.outcome}))}(F,3),H={supplierId:a.id,evaluatedCount:C,matchedCount:D,skippedCapabilityCount:E,recentExamples:G};return console.log("[supplier match] health loaded",{supplierId:a.id,evaluatedCount:C,matchedCount:D,skippedCapabilityCount:E,lookbackDays:g}),H}catch(a){return console.error("[supplier match] health failed",{supplierId:f,lookbackDays:g,error:a}),h}}async function z(a){try{let{data:b,error:c}=await f.w9.from("quotes_with_uploads").select(h.L.join(",")).in("status",Array.from(k.Hk)).gte("created_at",a).order("created_at",{ascending:!1}).limit(200);if(c)throw(0,g.n0)("quotes_with_uploads",c);return b??[]}catch(a){throw(0,g.n0)("quotes_with_uploads",a)}}async function A(a){let b=Array.from(new Set(a.map(a=>a.upload_id).filter(a=>"string"==typeof a&&a.length>0)));if(0===b.length)return new Map;try{let{data:a,error:c}=await f.w9.from("uploads").select("id,manufacturing_process").in("id",b).returns();if(c)throw(0,g.n0)("uploads",c);let d=new Map;return(a??[]).forEach(a=>{a?.id&&d.set(a.id,a.manufacturing_process??null)}),d}catch(a){throw(0,g.n0)("uploads",a)}}}};