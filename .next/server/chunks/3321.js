"use strict";exports.id=3321,exports.ids=[3321],exports.modules={3440:(a,b,c)=>{c.d(b,{j1:()=>g,z1:()=>h});var d=c(64811),e=c(33358);let f=new Set(e.Hk);function g(a,b,c){let e=(0,d.u_)(b);return!!e&&!!c&&("customer"===a?function(a,b){if(i([b.email,b.customer_email,...b.customerEmails??[],...b.allowedCustomerEmails??[]]).has(a))return!0;let c=a.split("@")[1];return!!c&&(function(a){let b=new Set;return a.forEach(a=>{if(!a)return;let c=a.trim().toLowerCase().replace(/^@/,"");c.includes(".")&&b.add(c)}),b})([b.customerDomain,b.orgDomain,...b.allowedCustomerDomains??[]]).has(c)}(e,c):"supplier"===a&&function(a,b){if(i([b.assigned_supplier_email,b.assignedSupplierEmail,...b.allowedSupplierEmails??[],...j(b.assignments),...j(b.supplierAssignments)]).has(a))return!0;let c=i(b.supplierContext?.verifiedEmails??[]);if(b.supplierContext?.verifiedAccess&&c.has(a))return!0;let e=(0,d.u_)(b.email??null);return!!e&&e===a}(e,c))}function h(a,b){var c;if("supplier"!==a||!b||!1===b.accessGranted||!1===b.allowBids||!0===b.bidLocked)return!1;let d=(0,e.Ao)(b.status);return!!f.has(d)&&"accepted"!==((c=b.existingBidStatus)?c.trim().toLowerCase():null)}function i(a){let b=new Set;return a.forEach(a=>{let c=(0,d.u_)(a??null);c&&b.add(c)}),b}function j(a){return a&&0!==a.length?a.map(a=>a?.supplier_email??a?.email??null):[]}},64811:(a,b,c)=>{async function d(a){if(void 0!==a)return await a}function e(a,b){var c;if(!a)return;if(c=a,"function"==typeof c?.get)return a.get(b)??void 0;let d=a[b];return Array.isArray(d)?d[0]:d}function f(a){if(!a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}function g(a){return a?a.startsWith("Q-")?a:`#${a.slice(0,6)}`:"Quote"}function h(a){return Array.isArray(a)?a[0]:a??void 0}c.d(b,{Ol:()=>d,VC:()=>e,nb:()=>h,u_:()=>f,xt:()=>g})},83321:(a,b,c)=>{c.d(b,{WP:()=>d.WP,g1:()=>e.g1,KF:()=>d.KF,w0:()=>t,KP:()=>d.KP,ZS:()=>d.ZS,_r:()=>l});var d=c(49669),e=c(43474),f=c(12831),g=c(2254),h=c(25049),i=c(3440),j=c(28503),k=c(33358);async function l(a){let b=a.supplierId??null,c=function(a){if("string"!=typeof a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}(a.supplierEmail),e={supplierId:b,supplierEmail:c,loader:"matches"};if(!b)return console.warn("[supplier activity] loading skipped",{...e,error:"Missing supplier identity"}),{ok:!1,data:[],error:"Missing supplier identity"};console.log("[supplier activity] loading",e);try{let a=await (0,d.n1)(b);if(!a)return console.warn("[supplier activity] loading skipped",{...e,error:"Supplier profile missing"}),{ok:!1,data:[],error:"Supplier profile missing"};let f={supplierId:a.id,supplierEmail:a.primary_email??c},g=(0,d.WP)(a),h=(0,j.Ef)(),l=!h||(0,d.m9)(a);if(h&&!l)return m("supplier skipped - not approved",{...f,approvalStatus:g,approvalsEnabled:h,supplierApproved:l}),console.log("[supplier activity] approvals gate active",{...e,approvalStatus:g}),{ok:!0,data:[],approvalGate:{enabled:!0,status:g}};let[s,t,u]=await Promise.all([(0,d.n8)(a.id),q(a.primary_email),r(a.id)]),v=function(a){let b=new Set,c=new Set;return a.forEach(a=>{let d=n(a.process);d&&b.add(d),(a.materials??[]).forEach(a=>{let b=function(a){if("string"!=typeof a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}(a);b&&c.add(b)})}),{processes:b,materials:c}}(s);if(0===v.processes.size)return m("supplier skipped - capability mismatch",{...f,reason:"No manufacturing processes recorded"}),console.log("[supplier activity] quote query result",{...e,count:0}),{ok:!0,data:[]};let w=new Set;t.forEach(a=>{a?.quote_id&&w.add(a.quote_id)}),u.forEach(a=>{a?.quote_id&&w.add(a.quote_id)});let x=a.verified||h&&l,y=await o();if(0===y.length)return console.log("[supplier activity] quote query result",{...e,count:0}),{ok:!0,data:[]};let z=await p(y),A=function(a){let b=0,c=[];a.assignmentCount<=2?(b+=1,c.push("Boosted because this supplier hasn’t been overexposed yet.")):a.assignmentCount>=8&&(b-=.5,c.push("Slight penalty to avoid routing everything to the same shop."));let d=a.recentBidOutcomes.filter(a=>{if(!a.status||"accepted"===a.status)return!1;let b=Date.parse(a.updated_at??"");return!Number.isNaN(b)&&(Date.now()-b)/864e5<=30}).length;return d>0&&(b+=Math.min(1.2,.3*d),c.push("Extra weight because they’ve been responding recently without being selected.")),0===a.recentBidOutcomes.length&&(b+=.4,c.push("New to bidding — giving them a gentle nudge into rotation.")),function(a){if(!a)return!1;let b=Date.parse(a);return!Number.isNaN(b)&&(Date.now()-b)/864e5<=45}(a.supplierCreatedAt)&&(b+=.8,c.push("Recently onboarded supplier gets a temporary boost.")),{modifier:b,reasons:c}}({assignmentCount:t.length,recentBidOutcomes:u,supplierCreatedAt:a.created_at}),B=[];for(let b of y){let c=b.id,d=b.status??null,e={...f,quoteId:c,quoteStatus:d};if(!(0,k.Bg)(d)){m("supplier skipped - RFQ not open",e);continue}let g=b.upload_id?z.get(b.upload_id):null,j=g?.manufacturing_process??null,o=n(j);if(!(o&&function(a,b){if(b.has(a))return!0;for(let c of b)if(a.includes(c)||c.includes(a))return!0;return!1}(o,v.processes))){m("supplier skipped - capability mismatch",{...e,processHint:j});continue}let p=x||!!c&&w.has(c);if(!p){m("supplier skipped - supplier inactive",{...e,approvalsEnabled:h,supplierApproved:l,supplierVerified:a.verified,reason:a.verified?"supplier not assigned to RFQ":"supplier not verified for global feed"});continue}let q=u.find(a=>a.quote_id===c);if(!(0,i.z1)("supplier",{status:b.status,existingBidStatus:q?.status??null,accessGranted:p})){m("supplier skipped - bidding blocked",{...e,existingBidStatus:q?.status??null,reason:"permission matrix denied bidding"});continue}let r=function(a,b){if(!a||0===b.size)return[];let c=[a.notes??"",a.rfq_reason??""].join(" ").toLowerCase(),d=[];return b.forEach(a=>{0!==a.length&&c.includes(a)&&d.push(a)}),d}(g,v.materials),s=function({createdAt:a,materialMatches:b}){let c;if(c=1+.5*b.length,a){let b=Date.parse(a);Number.isNaN(b)||(c+=Math.max(0,30-(Date.now()-b)/864e5)/10)}return c}({createdAt:b.created_at,materialMatches:r})+A.modifier;if(B.push({quoteId:c,quote:b,processHint:j,materialMatches:r,score:s,createdAt:b.created_at??null,quantityHint:g?.quantity??null,fairness:A.reasons.length>0?A:void 0}),m("supplier matched",{...e,processHint:j,score:s}),B.length>=20)break}let C=B.sort((a,b)=>b.score-a.score);return console.log("[supplier activity] quote query result",{...e,count:C.length}),{ok:!0,data:C}}catch(a){return(0,g.aH)({...e,query:(0,g.qr)(a,"matchQuotesToSupplier"),error:a}),{ok:!1,data:[],error:"Unable to load matches right now"}}}function m(a,b){console.log(`[matching] ${a}`,b)}function n(a){if("string"!=typeof a)return null;let b=a.trim().toLowerCase();return b.length>0?b:null}async function o(){try{let{data:a,error:b}=await f.w9.from("quotes_with_uploads").select(h.L.join(",")).in("status",Array.from(k.Hk)).order("created_at",{ascending:!1}).limit(50);if(b)throw(0,g.n0)("quotes_with_uploads",b);return a??[]}catch(a){throw(0,g.n0)("quotes_with_uploads",a)}}async function p(a){let b=Array.from(new Set(a.map(a=>a.upload_id).filter(a=>"string"==typeof a&&a.length>0)));if(0===b.length)return new Map;try{let{data:a,error:c}=await f.w9.from("uploads").select("id,manufacturing_process,quantity,rfq_reason,notes").in("id",b);if(c)throw(0,g.n0)("uploads",c);let d=new Map;return(a??[]).forEach(a=>{a?.id&&d.set(a.id,a)}),d}catch(a){throw(0,g.n0)("uploads",a)}}async function q(a){if(!a)return[];try{let{data:b,error:c}=await f.w9.from("quote_suppliers").select("quote_id").eq("supplier_email",a);if(c)throw(0,g.n0)("quote_suppliers",c);return b??[]}catch(a){throw(0,g.n0)("quote_suppliers",a)}}async function r(a){if(!a)return[];try{let{data:b,error:c}=await f.w9.from("supplier_bids").select("quote_id,status,updated_at").eq("supplier_id",a);if(c)throw(0,g.n0)("supplier_bids",c);return b??[]}catch(a){throw(0,g.n0)("supplier_bids",a)}}var s=c(31023);async function t(a,b){let c="string"==typeof a?a.trim():"";if(!c)return{};let d=Array.from(new Set((b??[]).map(a=>"string"==typeof a?a.trim():"").filter(a=>a.length>0)));if(0===d.length)return{};try{let{data:a,error:b}=await f.w9.from("supplier_bids").select("quote_id,status,created_at,updated_at").eq("supplier_id",c).in("quote_id",d).returns();if(b)return console.error("[supplier inbox] failed to load bid aggregates",{supplierId:c,quoteCount:d.length,error:(0,s.H)(b)}),{};let e={};for(let b of a??[]){let a=function(a){if("string"!=typeof a)return null;let b=a.trim();return b.length>0?b:null}(b?.quote_id);if(!a)continue;let c=e[a]??{quoteId:a,bidCount:0,lastBidAt:null,hasWinningBid:!1},d=function(a,b){let c=u(a),d=u(b);return c&&d?c>d?c:d:c??d??null}(b?.updated_at,b?.created_at);e[a]={quoteId:a,bidCount:c.bidCount+1,lastBidAt:!c.lastBidAt||d&&d>c.lastBidAt?d??c.lastBidAt:c.lastBidAt,hasWinningBid:c.hasWinningBid||function(a){if(!a)return!1;let b=a.trim().toLowerCase();return"won"===b||"winner"===b||"approved"===b}(b?.status??null)}}return console.info("[supplier inbox] bid aggregates loaded",{supplierId:c,quoteCount:d.length,withBids:Object.keys(e).length}),e}catch(a){return console.error("[supplier inbox] bid aggregates crashed",{supplierId:c,quoteCount:d.length,error:(0,s.H)(a)??a??null}),{}}}function u(a){if("string"!=typeof a)return null;let b=a.trim();return b.length>0?b:null}}};